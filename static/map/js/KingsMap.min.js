(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.KingsMap={})})("undefined"!=typeof window?window:this,function(e){function t(e,t){for(var n=Object.keys(t),o=n.length,i=0;i<o;i+=1)e[n[i]]=t[n[i]];return e}e.NAME="KingsMap",e.AUTHOR="Kingsley",e.EMAIL="kingsley.jf.tong@gmail.com",e.VERSION="1.3.4",e.VERSION_DATE="2018-07-23",e.IDM={},e.IDM.Browser={};var n=n||window.THREE,o={},i=document.scripts;i=i[i.length-1].src.substring(0,i[i.length-1].src.lastIndexOf("/")),o.path=i,o.libPath=o.path.substring(0,o.path.lastIndexOf("/")),o.imgPath=o.libPath+"/img",o.sourcePath=o.libPath+"/source";var r={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,n,o;e=e||{},t=void 0!==e.parent?e.parent:document.body,n=void 0!==e.id?e.id:"oldie",o=r.getWebGLErrorMessage(),o.id=n,t.appendChild(o)}};(function(){for(var e=0,t=["ms","moz","webkit","o"],n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var o=(new Date).getTime(),i=Math.max(0,16-(o-e)),r=window.setTimeout(function(){t(o+i)},i);return e=o+i,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})})(),function(){var t="ActiveXObject"in window,n=t&&!document.addEventListener,o=navigator.userAgent.toLowerCase(),i=-1!==o.indexOf("webkit"),r=-1!==o.indexOf("chrome"),a=-1!==o.indexOf("phantom"),s=-1!==o.indexOf("android"),l=-1!==o.search("android [23]"),c=-1!==o.indexOf("gecko"),d=-1!==o.indexOf("iphone"),u=-1!==o.indexOf("symbianos"),h=-1!==o.indexOf("windows phone"),p=-1!==o.indexOf("ipad"),m=d||h||u||s||p,f=window.navigator&&window.navigator.msPointerEnabled&&window.navigator.msMaxTouchPoints&&!window.PointerEvent,_=window.PointerEvent&&window.navigator.pointerEnabled&&window.navigator.maxTouchPoints||f,v="devicePixelRatio"in window&&1<window.devicePixelRatio||"matchMedia"in window&&window.matchMedia("(min-resolution:144dppi)")&&window.matchMedia("(min-resolution:144dppi)").matches,g=document.documentElement,y=t&&"transition"in g.style,M="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!l,w="MozPerspective"in g.style,b="OTransition"in g.style,D=!window.L_DISABLE_3D&&(y||M||w||b)&&!a,a=!window.L_NO_TOUCH&&!a&&function(){if(_||"ontouchstart"in g)return!0;var e=document.createElement("div"),t=!1;return!!e.setAttribute&&(e.setAttribute("ontouchstart","return;"),"function"==typeof e.ontouchstart&&(t=!0),e.removeAttribute("ontouchstart"),t)}();e.IDM.Browser={ie:t,ielt9:n,webkit:i,gecko:c&&!i&&!window.opera&&!t,android:s,android23:l,iphone:d,ipad:p,symbian:u,winphone:h,chrome:r,ie3d:y,webkit3d:M,gecko3d:w,opera3d:b,any3d:D,mobile:m,mobileWebkit:m&&i,mobileWebkit3d:m&&M,mobileOpera:m&&window.opera,touch:a,msPointer:f,pointer:_,retina:v}}();var a=function(e,t,n,o){this.tl=[e||0,t||0],this.br=[n||0,o||0]};a.prototype.isCollide=function(e){return!(e.br[0]<this.tl[0]||e.tl[0]>this.br[0]||e.br[1]<this.tl[1]||e.tl[1]>this.br[1])},e.IDM.GeomUtil={getBoundingRect:function(e){var t=new a,n=[];if(e.length<1)return t;for(var o=0,i=e.length;o<i;o++)n.push(e[o][0]),n.push(-e[o][1]);for(var r=9999999,s=9999999,l=-9999999,c=-9999999,o=0,i=n.length-1;o<i;o+=2)n[o]>l&&(l=n[o]),n[o]<r&&(r=n[o]),n[o+1]>c&&(c=n[o+1]),n[o+1]<s&&(s=n[o+1]);return t.tl=[r,s],t.tr=[l,s],t.bl=[r,c],t.br=[l,c],t.boundingBox={minX:r,minY:s,maxX:l,maxY:c},t},getCenterOfBounding:function(e){var t=e.tl[0],n=e.br[0],o=e.tl[1],i=e.bl[1],r=(t+n)/2,a=(o+i)/2;return[r,a]},translateCoord:function(e,t){var n=e[0],o=e[1],i=t[0],r=t[1],a=n-i,s=o-r;return[a,s]}},e.IDM.DomUtil={getElementLeft:function(e){for(var t=e.offsetLeft,n=e.offsetParent;null!==n;)t+=n.offsetLeft,n=n.offsetParent;return t},getElementTop:function(e){for(var t=e.offsetTop,n=e.offsetParent;null!==n;)t+=n.offsetTop,n=n.offsetParent;return t},getTranslateString:function(t){var n=e.IDM.Browser.webkit3d;return"translate"+(n?"3d":"")+"("+t[0]+"px,"+t[1]+"px"+((n?",0":"")+")")},getPos:function(t){return t._idm_pos?t._idm_pos:[e.IDM.DomUtil.getElementLeft(t),e.IDM.DomUtil.getElementTop(t)]},setPos:function(t,n){t._idm_pos=n,e.IDM.Browser.any3d?t.style[e.IDM.DomUtil.TRANSFORM]=e.IDM.DomUtil.getTranslateString(n):(t.style.left=n[0]+"px",t.style.top=n[1]+"px")},testProp:function(e){for(var t=document.documentElement.style,n=0;n<e.length;n++)if(e[n]in t)return e[n];return!1}},e.IDM.DomUtil.TRANSFORM=e.IDM.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),e.IDM.DomUtil.TRANSITION=e.IDM.DomUtil.testProp(["webkitTransition","transition","OTransition","MozTransition","msTransition"]),e.IDM.DomUtil.TRANSITION_END="webkitTransition"===e.IDM.DomUtil.TRANSITION||"OTransition"===e.IDM.DomUtil.TRANSITION?e.IDM.DomUtil.TRANSITION+"End":"transitionend";var s=s||function(){var e={},t={},n=0;return{getAll:function(){return Object.keys(e).map(function(t){return e[t]})},removeAll:function(){e={}},add:function(n){e[n.getId()]=n,t[n.getId()]=n},remove:function(n){delete e[n.getId()],delete t[n.getId()]},update:function(n,o){var i=Object.keys(e);if(0===i.length)return!1;for(n=void 0!==n?n:s.now();i.length>0;){t={};for(var r=0;r<i.length;r++)e[i[r]].update(n)!==!1||o||delete e[i[r]];i=Object.keys(t)}return!0},nextId:function(){return n++}}}();"undefined"==typeof window&&"undefined"!=typeof process?s.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?s.now=window.performance.now.bind(window.performance):void 0!==Date.now?s.now=Date.now:s.now=function(){return(new Date).getTime()},s.Tween=function(e){this._object=e,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._repeat=0,this._repeatDelayTime=void 0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=null,this._easingFunction=s.Easing.Linear.None,this._interpolationFunction=s.Interpolation.Linear,this._chainedTweens=[],this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onCompleteCallback=null,this._onStopCallback=null,this._id=s.nextId()},s.Tween.prototype={getId:function(){return this._id},to:function(e,t){return this._valuesEnd=e,void 0!==t&&(this._duration=t),this},start:function(e){s.add(this),this._isPlaying=!0,this._onStartCallbackFired=!1,this._startTime=void 0!==e?e:s.now(),this._startTime+=this._delayTime;for(var t in this._valuesEnd){if(this._valuesEnd[t]instanceof Array){if(0===this._valuesEnd[t].length)continue;this._valuesEnd[t]=[this._object[t]].concat(this._valuesEnd[t])}void 0!==this._object[t]&&(this._valuesStart[t]=this._object[t],this._valuesStart[t]instanceof Array==!1&&(this._valuesStart[t]*=1),this._valuesStartRepeat[t]=this._valuesStart[t]||0)}return this},stop:function(){return this._isPlaying?(s.remove(this),this._isPlaying=!1,null!==this._onStopCallback&&this._onStopCallback.call(this._object,this._object),this.stopChainedTweens(),this):this},end:function(){return this.update(this._startTime+this._duration),this},stopChainedTweens:function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop()},delay:function(e){return this._delayTime=e,this},repeat:function(e){return this._repeat=e,this},repeatDelay:function(e){return this._repeatDelayTime=e,this},yoyo:function(e){return this._yoyo=e,this},easing:function(e){return this._easingFunction=e,this},interpolation:function(e){return this._interpolationFunction=e,this},chain:function(){return this._chainedTweens=arguments,this},onStart:function(e){return this._onStartCallback=e,this},onUpdate:function(e){return this._onUpdateCallback=e,this},onComplete:function(e){return this._onCompleteCallback=e,this},onStop:function(e){return this._onStopCallback=e,this},update:function(e){var t,n,o;if(e<this._startTime)return!0;this._onStartCallbackFired===!1&&(null!==this._onStartCallback&&this._onStartCallback.call(this._object,this._object),this._onStartCallbackFired=!0),n=(e-this._startTime)/this._duration,n=n>1?1:n,o=this._easingFunction(n);for(t in this._valuesEnd)if(void 0!==this._valuesStart[t]){var i=this._valuesStart[t]||0,r=this._valuesEnd[t];r instanceof Array?this._object[t]=this._interpolationFunction(r,o):("string"==typeof r&&(r="+"===r.charAt(0)||"-"===r.charAt(0)?i+parseFloat(r):parseFloat(r)),"number"==typeof r&&(this._object[t]=i+(r-i)*o))}if(null!==this._onUpdateCallback&&this._onUpdateCallback.call(this._object,o),1===n){if(this._repeat>0){isFinite(this._repeat)&&this._repeat--;for(t in this._valuesStartRepeat){if("string"==typeof this._valuesEnd[t]&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo){var a=this._valuesStartRepeat[t];this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=a}this._valuesStart[t]=this._valuesStartRepeat[t]}return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,!0}null!==this._onCompleteCallback&&this._onCompleteCallback.call(this._object,this._object);for(var s=0,l=this._chainedTweens.length;s<l;s++)this._chainedTweens[s].start(this._startTime+this._duration);return!1}return!0}},s.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2,e<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1)}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?.5*(e*e*((t+1)*e-t)):.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-s.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*s.Easing.Bounce.In(2*e):.5*s.Easing.Bounce.Out(2*e-1)+.5}}},s.Interpolation={Linear:function(e,t){var n=e.length-1,o=n*t,i=Math.floor(o),r=s.Interpolation.Utils.Linear;return t<0?r(e[0],e[1],o):t>1?r(e[n],e[n-1],n-o):r(e[i],e[i+1>n?n:i+1],o-i)},Bezier:function(e,t){for(var n=0,o=e.length-1,i=Math.pow,r=s.Interpolation.Utils.Bernstein,a=0;a<=o;a++)n+=i(1-t,o-a)*i(t,a)*e[a]*r(o,a);return n},CatmullRom:function(e,t){var n=e.length-1,o=n*t,i=Math.floor(o),r=s.Interpolation.Utils.CatmullRom;return e[0]===e[n]?(t<0&&(i=Math.floor(o=n*(1+t))),r(e[(i-1+n)%n],e[i],e[(i+1)%n],e[(i+2)%n],o-i)):t<0?e[0]-(r(e[0],e[0],e[1],e[1],-o)-e[0]):t>1?e[n]-(r(e[n],e[n],e[n-1],e[n-1],o-n)-e[n]):r(e[i?i-1:0],e[i],e[n<i+1?n:i+1],e[n<i+2?n:i+2],o-i)},Utils:{Linear:function(e,t,n){return(t-e)*n+e},Bernstein:function(e,t){var n=s.Interpolation.Utils.Factorial;return n(e)/n(t)/n(e-t)},Factorial:function(){var e=[1];return function(t){var n=1;if(e[t])return e[t];for(var o=t;o>1;o--)n*=o;return e[t]=n,n}}(),CatmullRom:function(e,t,n,o,i){var r=.5*(n-e),a=.5*(o-t),s=i*i,l=i*s;return(2*t-2*n+r+a)*l+(-3*t+3*n-2*r-a)*s+r*i+t}}},function(e){e.TWEEN=s}("undefined"!=typeof window?window:this),function(e,t,n){t[e]=n()}("h337","undefined"!=typeof window?window:this,function(){var e={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},t=function(){var t=function(e){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=e.xField||e.defaultXField,this._yField=e.yField||e.defaultYField,this._valueField=e.valueField||e.defaultValueField,e.radius&&(this._cfgRadius=e.radius)},n=e.defaultRadius;return t.prototype={_organiseData:function(e,t){var o=e[this._xField],i=e[this._yField],r=this._radi,a=this._data,s=this._max,l=this._min,c=e[this._valueField]||1,d=e.radius||this._cfgRadius||n;a[o]||(a[o]=[],r[o]=[]),a[o][i]?a[o][i]+=c:(a[o][i]=c,r[o][i]=d);var u=a[o][i];return u>s?(t?this.setDataMax(u):this._max=u,!1):u<l?(t?this.setDataMin(u):this._min=u,!1):{x:o,y:i,value:c,radius:d,min:l,max:s}},_unOrganizeData:function(){var e=[],t=this._data,n=this._radi;for(var o in t)for(var i in t[o])e.push({x:o,y:i,radius:n[o][i],value:t[o][i]});return{min:this._min,max:this._max,data:e}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var e=arguments[0],t=e.length;t--;)this.addData.call(this,e[t]);else{var n=this._organiseData(arguments[0],!0);n&&(0===this._data.length&&(this._min=this._max=n.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[n]}))}return this},setData:function(e){var t=e.data,n=t.length;this._data=[],this._radi=[];for(var o=0;o<n;o++)this._organiseData(t[o],!1);return this._max=e.max,this._min=e.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(e){return this._max=e,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(e){return this._min=e,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(e){this._coordinator=e},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},t}(),n=function(){function e(e){var n=e.container,o=this.shadowCanvas=document.createElement("canvas"),i=this.canvas=e.canvas||document.createElement("canvas"),r=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(e.container)||{});i.className="heatmap-canvas",this._width=i.width=o.width=e.width||+r.width.replace(/px/,""),this._height=i.height=o.height=e.height||+r.height.replace(/px/,""),this.shadowCtx=o.getContext("2d"),this.ctx=i.getContext("2d"),i.style.cssText=o.style.cssText="position:absolute;left:0;top:0;",n.style.position="relative",n.appendChild(i),this._palette=t(e),this._templates={},this._setStyles(e)}var t=function(e){var t=e.gradient||e.defaultGradient,n=document.createElement("canvas"),o=n.getContext("2d");n.width=256,n.height=1;var i=o.createLinearGradient(0,0,256,1);for(var r in t)i.addColorStop(r,t[r]);return o.fillStyle=i,o.fillRect(0,0,256,1),o.getImageData(0,0,256,1).data},n=function(e,t){var n=document.createElement("canvas"),o=n.getContext("2d"),i=e,r=e;if(n.width=n.height=2*e,1==t)o.beginPath(),o.arc(i,r,e,0,2*Math.PI,!1),o.fillStyle="rgba(0,0,0,1)",o.fill();else{var a=o.createRadialGradient(i,r,e*t,i,r,e);a.addColorStop(0,"rgba(0,0,0,1)"),a.addColorStop(1,"rgba(0,0,0,0)"),o.fillStyle=a,o.fillRect(0,0,2*e,2*e)}return n},o=function(e){for(var t=[],n=e.min,o=e.max,i=e.radi,e=e.data,r=Object.keys(e),a=r.length;a--;)for(var s=r[a],l=Object.keys(e[s]),c=l.length;c--;){var d=l[c],u=e[s][d],h=i[s][d];t.push({x:s,y:d,value:u,radius:h})}return{min:n,max:o,data:t}};return e.prototype={renderPartial:function(e){e.data.length>0&&(this._drawAlpha(e),this._colorize())},renderAll:function(e){this._clear(),e.data.length>0&&(this._drawAlpha(o(e)),this._colorize())},_updateGradient:function(e){this._palette=t(e)},updateConfig:function(e){e.gradient&&this._updateGradient(e),this._setStyles(e)},setDimensions:function(e,t){this._width=e,this._height=t,this.canvas.width=this.shadowCanvas.width=e,this.canvas.height=this.shadowCanvas.height=t},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(e){this._blur=0==e.blur?0:e.blur||e.defaultBlur,e.backgroundColor&&(this.canvas.style.backgroundColor=e.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=e.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=e.height||this._height,this._opacity=255*(e.opacity||0),this._maxOpacity=255*(e.maxOpacity||e.defaultMaxOpacity),this._minOpacity=255*(e.minOpacity||e.defaultMinOpacity),this._useGradientOpacity=!!e.useGradientOpacity},_drawAlpha:function(e){for(var t=this._min=e.min,o=this._max=e.max,e=e.data||[],i=e.length,r=1-this._blur;i--;){var a,s=e[i],l=s.x,c=s.y,d=s.radius,u=Math.min(s.value,o),h=l-d,p=c-d,m=this.shadowCtx;this._templates[d]?a=this._templates[d]:this._templates[d]=a=n(d,r);var f=(u-t)/(o-t);m.globalAlpha=f<.01?.01:f,m.drawImage(a,h,p),h<this._renderBoundaries[0]&&(this._renderBoundaries[0]=h),p<this._renderBoundaries[1]&&(this._renderBoundaries[1]=p),h+2*d>this._renderBoundaries[2]&&(this._renderBoundaries[2]=h+2*d),p+2*d>this._renderBoundaries[3]&&(this._renderBoundaries[3]=p+2*d)}},_colorize:function(){var e=this._renderBoundaries[0],t=this._renderBoundaries[1],n=this._renderBoundaries[2]-e,o=this._renderBoundaries[3]-t,i=this._width,r=this._height,a=this._opacity,s=this._maxOpacity,l=this._minOpacity,c=this._useGradientOpacity;e<0&&(e=0),t<0&&(t=0),e+n>i&&(n=i-e),t+o>r&&(o=r-t);for(var d=this.shadowCtx.getImageData(e,t,n,o),u=d.data,h=u.length,p=this._palette,m=3;m<h;m+=4){var f=u[m],_=4*f;if(_){var v;v=a>0?a:f<s?f<l?l:f:s,u[m-3]=p[_],u[m-2]=p[_+1],u[m-1]=p[_+2],u[m]=c?p[_+3]:v}}d.data=u,this.ctx.putImageData(d,e,t),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(e){var t,n=this.shadowCtx,o=n.getImageData(e.x,e.y,1,1),i=o.data[3],r=this._max,a=this._min;return t=Math.abs(r-a)*(i/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},e}(),o=function(){var t=!1;return"canvas2d"===e.defaultRenderer&&(t=n),t}(),i={merge:function(){for(var e={},t=arguments.length,n=0;n<t;n++){var o=arguments[n];for(var i in o)e[i]=o[i]}return e}},r=function(){function n(){var n=this._config=i.merge(e,arguments[0]||{});if(this._coordinator=new r,n.plugin){var s=n.plugin;if(!e.plugins[s])throw new Error("Plugin '"+s+"' not found. Maybe it was not registered.");var l=e.plugins[s];this._renderer=new l.renderer(n),this._store=new l.store(n)}else this._renderer=new o(n),this._store=new t(n);a(this)}var r=function(){function e(){this.cStore={}}return e.prototype={on:function(e,t,n){var o=this.cStore;o[e]||(o[e]=[]),o[e].push(function(e){return t.call(n,e)})},emit:function(e,t){var n=this.cStore;if(n[e])for(var o=n[e].length,i=0;i<o;i++){var r=n[e][i];r(t)}}},e}(),a=function(e){var t=e._renderer,n=e._coordinator,o=e._store;n.on("renderpartial",t.renderPartial,t),n.on("renderall",t.renderAll,t),n.on("extremachange",function(t){e._config.onExtremaChange&&e._config.onExtremaChange({min:t.min,max:t.max,gradient:e._config.gradient||e._config.defaultGradient})}),o.setCoordinator(n)};return n.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(e){return this._config=i.merge(this._config,e),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(e){return this._store.getValueAt?this._store.getValueAt(e):this._renderer.getValueAt?this._renderer.getValueAt(e):null}},n}(),a={create:function(e){return new r(e)},register:function(t,n){e.plugins[t]=n}};return a}),function(){for(var i={MODE_VIEW_MODE:!0,MODE_FLASH_MODE:!0,MODE_LOADER_1:"circle",MODE_LOADER_2:"pacman",MODE_LOADER_3:"diamond"},l={MODE_WALL_TABLE:"table",MODE_WALL_SPHERE:"sphere",MODE_WALL_HELIX:"helix",MODE_WALL_GRID:"grid"},c={MODE_3D:"3D",MODE_2D:"2D",MODE_ALL:"ALL",MODE_ONE:"ONE",MODE_MAX_ANGLE:Math.PI/2,MODE_MIN_ANGLE:Math.PI/3},d={MODE_COMPASS:!1,MODE_VIEW_MODE:!1,MODE_FLOORS:!1,MODE_ZOOM:!1,MODE_LEFT_TOP:[15,15],MODE_RIGHT_TOP:[-15,15],MODE_LEFT_BOTTOM:[15,-15],MODE_RIGHT_BOTTOM:[-15,-15]},u={MODE_SCALE:.5,MODE_CAMERA_LENGTH:1600,MODE_CAMERA_LENGTH_MAX:1700,MODE_CAMERA_LENGTH_MIN:100,MODE_SCALE_RANGE:[1,16],MODE_SCALE_MAX:16,MODE_SCALE_MIN:1,MODE_SCALE_DEFAULT:10,MODE_CAMERA_SCALE_AVG:100},h={MODE_FLOOR_DEFAULT_ID:"-2018",MODE_FLOOR_HEIGHT:3,MODE_FLOOR_NAME:!1,MODE_MODEL_SELECTED:!1,MODE_SHOW_POI:!1},p={11001:o.imgPath+"/toilet.png",11002:o.imgPath+"/atm.png",11003:o.imgPath+"/stair.png",11004:o.imgPath+"/entry.png",11005:o.imgPath+"/escalator.png",11006:o.imgPath+"/lift.png",11007:o.imgPath+"/park.png",11010:o.imgPath+"/cabinet.png",11011:o.imgPath+"/fire.png"},m={scale:.1},f={blockHeight:5,roomHeight:1,floorHeight:3},_={DEFAULT_3D_THEME:{name:"default3DTheme",background:"rgb(190,232,255)",building:{color:"#000000",opacity:.1,transparent:!0,depthTest:!1},floor:{color:"rgb(190,232,255)",opacity:1,transparent:!1},selected:"#ffff55",wall:{color:"rgb(255,241,222)",opacity:1,transparent:!0},wire:{color:"#5C4433",opacity:1,transparent:!0},desk:{color:"#69BC91",opacity:.7,transparent:!0},chair:{color:"#5EB2E5",opacity:1,transparent:!0},room:{default:{color:"rgb(255,241,222)",opacity:1,transparent:!0},"":{color:"rgb(255,241,222)",opacity:1,transparent:!0},101:{color:"rgb(255,241,222)",opacity:.6,transparent:!0},102:{color:"rgb(255,180,74)",opacity:.6,transparent:!0},103:{color:"rgb(255,180,74)",opacity:.6,transparent:!0},104:{color:"rgb(115,178,115)",opacity:.6,transparent:!0},105:{color:"#F8D2ED",opacity:.6,transparent:!0},106:{color:"#C6E5D7",opacity:.6,transparent:!0},107:{color:"#DBDB8D",opacity:.6,transparent:!0},108:{color:"#EE8A31",opacity:.6,transparent:!0},109:{color:"#D8C8DF",opacity:.6,transparent:!0}},strokeStyle:{color:"#5C4433",opacity:.5,transparent:!0,linewidth:2},fontStyle:{color:"#231815",fontsize:40,fontface:"Helvetica, MicrosoftYaHei "}}},v=Object.getPrototypeOf,g={},y=g.toString,M=g.hasOwnProperty,w=M.toString,b=w.call(Object),D="Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),E=0;E<D.length;E++){var x=D[E];g["[object "+x+"]"]=x.toLowerCase()}n.OrbitControls=function(e,t){function o(){return 2*Math.PI/60/60*f.autoRotateSpeed}function i(){return Math.pow(.95,f.userZoomSpeed)}function r(e){f.enabled!==!1&&f.userRotate!==!1&&(e.preventDefault(),T===L.NONE&&(0===e.button&&(T=L.PAN),1===e.button&&(T=L.ZOOM),2===e.button&&(T=L.ROTATE)),T===L.ROTATE?g.set(e.clientX,e.clientY):T===L.ZOOM?w.set(e.clientX,e.clientY):T===L.PAN&&E.set(e.clientX,e.clientY),document.addEventListener("mousemove",a,!1),document.addEventListener("mouseup",s,!1))}function a(e){f.enabled!==!1&&(e.preventDefault(),T===L.ROTATE?(y.set(e.clientX,e.clientY),M.subVectors(y,g),f.rotateLeft(2*Math.PI*M.x/v*f.userRotateSpeed),f.rotateUp(2*Math.PI*M.y/v*f.userRotateSpeed),g.copy(y)):T===L.ZOOM?(b.set(e.clientX,e.clientY),D.subVectors(b,w),D.y>0?f.zoomIn():f.zoomOut(),w.copy(b)):T===L.PAN&&(x.set(e.clientX,e.clientY),C.subVectors(x,E),f.pan(new n.Vector3(-C.x,C.y,0)),E.copy(x)))}function s(e){f.enabled!==!1&&f.userRotate!==!1&&(document.removeEventListener("mousemove",a,!1),document.removeEventListener("mouseup",s,!1),T=L.NONE)}function l(e){if(f.enabled!==!1&&f.userZoom!==!1){var t=0;e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-e.detail),t>0?f.zoomOut():f.zoomIn()}}function c(e){if(f.enabled!==!1&&f.userPan!==!1)switch(e.keyCode){case f.keys.ROTATE:T=L.ROTATE;break;case f.keys.ZOOM:T=L.ZOOM;break;case f.keys.PAN:T=L.PAN}}function d(e){switch(e.keyCode){case f.keys.ROTATE:case f.keys.ZOOM:case f.keys.PAN:T=L.NONE}}function h(e){if(f.enabled!==!1){switch(e.touches.length){case 2:T=L.TOUCH_ROTATE,g.copy(e.touches[0].clientX,e.touches[0].clientY),y.copy(g);break;case 1:T=L.TOUCH_ZOOM_PAN,E.set(e.touches[0].clientX,e.touches[0].clientY);break;default:T=L.NONE}document.addEventListener("touchend",m,!1),document.addEventListener("touchmove",p,!1),f.dispatchEvent(k)}}function p(e){if(f.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 2:y.copy(e.touches[0].clientX,e.touches[0].clientY);break;case 1:x.set(e.touches[0].clientX,e.touches[0].clientY),C.subVectors(x,E),f.pan(new n.Vector3(-C.x,C.y,0)),E.copy(x);break;default:T=L.NONE}}function m(e){f.enabled!==!1&&(document.removeEventListener("touchend",m,!1),document.removeEventListener("touchmove",p,!1),T=L.NONE,f.dispatchEvent(F))}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.center=new n.Vector3,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.userPan=!0,this.userPanSpeed=1.5,this.storePanSpeed=1.5,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI/2,this.minDistance=0,this.maxDistance=1/0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40,ROTATE:65,ZOOM:83,PAN:68},this.viewChanged=!0;var f=this,_=1e-6,v=1800,g=new n.Vector2,y=new n.Vector2,M=new n.Vector2,w=new n.Vector2,b=new n.Vector2,D=new n.Vector2,E=new n.Vector2,x=new n.Vector2,C=new n.Vector2,S=0,O=0,I=1,A=new n.Vector3,L={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},T=L.NONE,P={type:"change"},k={type:"start"},F={type:"end"};this.reset=function(){g=new n.Vector2,y=new n.Vector2,M=new n.Vector2,w=new n.Vector2,b=new n.Vector2,D=new n.Vector2,E=new n.Vector2,x=new n.Vector2,C=new n.Vector2,S=0,O=0,I=1,A=new n.Vector3,T=L.NONE,this.center=new n.Vector3},this.rotateLeft=function(e){void 0===e&&(e=o()),O-=e},this.rotateRight=function(e){void 0===e&&(e=o()),O+=e},this.rotateUp=function(e){void 0===e&&(e=o()),S-=e},this.rotateDown=function(e){void 0===e&&(e=o()),S+=e},this.zoomIn=function(e){void 0===e&&(e=i()),I/=e;var t=f.object.position.x,n=f.object.position.y,o=f.object.position.z,r=Math.round(Math.sqrt(t*t+n*n+o*o)),a=u.MODE_CAMERA_LENGTH_MAX/r/(u.MODE_SCALE_MAX+1);R._curScale=Math.round((u.MODE_CAMERA_LENGTH_MAX-r)/u.MODE_CAMERA_SCALE_AVG)||1,f.userPanSpeed=Math.round(f.storePanSpeed/a)},this.zoomOut=function(e){void 0===e&&(e=i()),I*=e;var t=f.object.position.x,n=f.object.position.y,o=f.object.position.z,r=Math.round(Math.sqrt(t*t+n*n+o*o)),a=u.MODE_CAMERA_LENGTH_MAX/r/(u.MODE_SCALE_MAX+1);R._curScale=Math.round((u.MODE_CAMERA_LENGTH_MAX-r)/u.MODE_CAMERA_SCALE_AVG),f.userPanSpeed=Math.round(f.storePanSpeed/a)},this.pan=function(e){e.transformDirection(this.object.matrix),e.multiplyScalar(f.userPanSpeed),this.object.position.add(e),this.center.add(e)},this.update=function(){var e=this.object.position,t=e.clone().sub(this.center),n=Math.atan2(t.x,t.z),i=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),t.y);this.autoRotate&&this.rotateLeft(o()),n+=O,i+=S,i=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,i)),i=Math.max(_,Math.min(Math.PI-_,i));var r=t.length()*I;r=Math.max(this.minDistance,Math.min(this.maxDistance,r)),t.x=r*Math.sin(i)*Math.sin(n),t.y=r*Math.cos(i),t.z=r*Math.sin(i)*Math.cos(n),e.copy(this.center).add(t),this.object.lookAt(this.center),O=0,S=0,I=1,A.distanceTo(this.object.position)>0&&(this.dispatchEvent(P),A.copy(this.object.position),this.viewChanged=!0)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mousewheel",l,!1),this.domElement.addEventListener("DOMMouseScroll",l,!1),this.domElement.addEventListener("touchstart",h,!1),window.addEventListener("keydown",c,!1),window.addEventListener("keyup",d,!1)},n.OrbitControls.prototype=Object.create(n.EventDispatcher.prototype),n.CSS3DObject=function(e){n.Object3D.call(this),this.element=e,this.element.style.position="absolute",this.addEventListener("removed",function(){null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)})},n.CSS3DObject.prototype=Object.create(n.Object3D.prototype),n.CSS3DObject.prototype.constructor=n.CSS3DObject,n.CSS3DSprite=function(e){n.CSS3DObject.call(this,e)},n.CSS3DSprite.prototype=Object.create(n.CSS3DObject.prototype),n.CSS3DSprite.prototype.constructor=n.CSS3DSprite,n.CSS3DRenderer=function(){function e(e){return Math.abs(e)<1e-10?0:e}function t(t){var n=t.elements;return"matrix3d("+e(n[0])+","+e(-n[1])+","+e(n[2])+","+e(n[3])+","+e(n[4])+","+e(-n[5])+","+e(n[6])+","+e(n[7])+","+e(n[8])+","+e(-n[9])+","+e(n[10])+","+e(n[11])+","+e(n[12])+","+e(-n[13])+","+e(n[14])+","+e(n[15])+")"}function o(t,n){var o=t.elements,i="matrix3d("+e(o[0])+","+e(o[1])+","+e(o[2])+","+e(o[3])+","+e(-o[4])+","+e(-o[5])+","+e(-o[6])+","+e(-o[7])+","+e(o[8])+","+e(o[9])+","+e(o[10])+","+e(o[11])+","+e(o[12])+","+e(o[13])+","+e(o[14])+","+e(o[15])+")";return m?"translate(-50%,-50%)translate("+l+"px,"+c+"px)"+n+i:"translate(-50%,-50%)"+i}function i(e,t,r){if(e instanceof n.CSS3DObject){var a;e instanceof n.CSS3DSprite?(d.copy(t.matrixWorldInverse),d.transpose(),d.copyPosition(e.matrixWorld),d.scale(e.scale),d.elements[3]=0,d.elements[7]=0,d.elements[11]=0,d.elements[15]=1,a=o(d,r)):a=o(e.matrixWorld,r);var s=e.element,l=u.objects[e.id]&&u.objects[e.id].style;void 0!==l&&l===a||(s.style.WebkitTransform=a,s.style.MozTransform=a,s.style.transform=a,u.objects[e.id]={style:a},m&&(u.objects[e.id].distanceToCameraSquared=f(t,e))),s.parentNode!==p&&p.appendChild(s)}for(var c=0,h=e.children.length;c<h;c++)i(e.children[c],t,r)}function r(e){var t=Object.keys(u.objects).sort(function(e,t){
return u.objects[e].distanceToCameraSquared-u.objects[t].distanceToCameraSquared}),n=t.length;e.traverse(function(e){var o=t.indexOf(e.id+"");o!==-1&&(e.element.style.zIndex=n-o)})}var a,s,l,c,d=new n.Matrix4,u={camera:{fov:0,style:""},objects:{}},h=document.createElement("div");h.style.overflow="hidden",this.domElement=h;var p=document.createElement("div");p.style.WebkitTransformStyle="preserve-3d",p.style.MozTransformStyle="preserve-3d",p.style.transformStyle="preserve-3d",h.appendChild(p);var m=/Trident/i.test(navigator.userAgent);this.setClearColor=function(){},this.getSize=function(){return{width:a,height:s}},this.setSize=function(e,t){a=e,s=t,l=a/2,c=s/2,h.style.width=e+"px",h.style.height=t+"px",p.style.width=e+"px",p.style.height=t+"px"};var f=function(){var e=new n.Vector3,t=new n.Vector3;return function(n,o){return e.setFromMatrixPosition(n.matrixWorld),t.setFromMatrixPosition(o.matrixWorld),e.distanceToSquared(t)}}();this.render=function(e,n){var o=n.projectionMatrix.elements[5]*c;u.camera.fov!==o&&(h.style.WebkitPerspective=o+"px",h.style.MozPerspective=o+"px",h.style.perspective=o+"px",u.camera.fov=o),e.updateMatrixWorld(),null===n.parent&&n.updateMatrixWorld();var a="translateZ("+o+"px)"+t(n.matrixWorldInverse),s=a+"translate("+l+"px,"+c+"px)";u.camera.style===s||m||(p.style.WebkitTransform=s,p.style.MozTransform=s,p.style.transform=s,u.camera.style=s),i(e,n,a),m&&r(e)}},n.SpriteCanvasMaterial=function(e){n.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new n.Color(16777215),this.program=function(){},this.setValues(e)},n.SpriteCanvasMaterial.prototype=Object.create(n.Material.prototype),n.SpriteCanvasMaterial.prototype.constructor=n.SpriteCanvasMaterial,n.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0,n.SpriteCanvasMaterial.prototype.clone=function(){var e=new n.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},n.CanvasRenderer=function(e){function t(){ve.setRGB(0,0,0),ge.setRGB(0,0,0),ye.setRGB(0,0,0);for(var e=0,t=D.length;e<t;e++){var n=D[e],o=n.color;n.isAmbientLight?ve.add(o):n.isDirectionalLight?ge.add(o):n.isPointLight&&ye.add(o)}}function o(e,t,n){for(var o=0,i=D.length;o<i;o++){var r=D[o];if(he.copy(r.color),r.isDirectionalLight){var a=Me.setFromMatrixPosition(r.matrixWorld).normalize(),s=t.dot(a);if(s<=0)continue;s*=r.intensity,n.add(he.multiplyScalar(s))}else if(r.isPointLight){var a=Me.setFromMatrixPosition(r.matrixWorld),s=t.dot(Me.subVectors(a,e).normalize());if(s<=0)continue;if(s*=0==r.distance?1:1-Math.min(e.distanceTo(a)/r.distance,1),0==s)continue;s*=r.intensity,n.add(he.multiplyScalar(s))}}}function i(e,t,n){p(n.opacity),m(n.blending);var o=t.scale.x*G,i=t.scale.y*U,r=Math.sqrt(o*o+i*i);if(_e.min.set(e.x-r,e.y-r),_e.max.set(e.x+r,e.y+r),n.isSpriteMaterial){var a=n.map;if(null!==a){var s=pe[a.id];if(void 0!==s&&s.version===a.version||(s=d(a),pe[a.id]=s),void 0!==s.canvas){y(s.canvas);var l=a.image,c=l.width*a.offset.x,u=l.height*a.offset.y,h=l.width*a.repeat.x,f=l.height*a.repeat.y,_=o/h,v=i/f;Q.save(),Q.translate(e.x,e.y),0!==n.rotation&&Q.rotate(n.rotation),Q.translate(-o/2,-i/2),Q.scale(_,v),Q.translate(-c,-u),Q.fillRect(c,u,h,f),Q.restore()}}else y(n.color.getStyle()),Q.save(),Q.translate(e.x,e.y),0!==n.rotation&&Q.rotate(n.rotation),Q.scale(o,-i),Q.fillRect(-.5,-.5,1,1),Q.restore()}else n.isSpriteCanvasMaterial?(g(n.color.getStyle()),y(n.color.getStyle()),Q.save(),Q.translate(e.x,e.y),0!==n.rotation&&Q.rotate(n.rotation),Q.scale(o,i),n.program(Q),Q.restore()):n.isPointsMaterial&&(y(n.color.getStyle()),Q.save(),Q.translate(e.x,e.y),0!==n.rotation&&Q.rotate(n.rotation),Q.scale(o*n.size,-i*n.size),Q.fillRect(-.5,-.5,1,1),Q.restore())}function r(e,t,o,i){if(p(i.opacity),m(i.blending),Q.beginPath(),Q.moveTo(e.positionScreen.x,e.positionScreen.y),Q.lineTo(t.positionScreen.x,t.positionScreen.y),i.isLineBasicMaterial){if(f(i.linewidth),_(i.linecap),v(i.linejoin),i.vertexColors!==n.VertexColors)g(i.color.getStyle());else{var r=o.vertexColors[0].getStyle(),a=o.vertexColors[1].getStyle();if(r===a)g(r);else{try{var s=Q.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);s.addColorStop(0,r),s.addColorStop(1,a)}catch(e){s=r}g(s)}}i.isLineDashedMaterial&&M([i.dashSize,i.gapSize]),Q.stroke(),_e.expandByScalar(2*i.linewidth),i.isLineDashedMaterial&&M([])}}function a(e,t,i,r,a,d,h,f){if(j.info.render.vertices+=3,j.info.render.faces++,p(f.opacity),m(f.blending),S=e.positionScreen.x,O=e.positionScreen.y,I=t.positionScreen.x,A=t.positionScreen.y,L=i.positionScreen.x,T=i.positionScreen.y,s(S,O,I,A,L,T),(f.isMeshLambertMaterial||f.isMeshPhongMaterial||f.isMeshStandardMaterial)&&null===f.map)de.copy(f.color),ue.copy(f.emissive),f.vertexColors===n.FaceColors&&de.multiply(h.color),ce.copy(ve),we.copy(e.positionWorld).add(t.positionWorld).add(i.positionWorld).divideScalar(3),o(we,h.normalModel,ce),ce.multiply(de).add(ue),f.wireframe===!0?l(ce,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):c(ce);else if(f.isMeshBasicMaterial||f.isMeshLambertMaterial||f.isMeshPhongMaterial||f.isMeshStandardMaterial)if(null!==f.map){var _=f.map.mapping;_===n.UVMapping&&(P=h.uvs,u(S,O,I,A,L,T,P[r].x,P[r].y,P[a].x,P[a].y,P[d].x,P[d].y,f.map))}else null!==f.envMap?f.envMap.mapping===n.SphericalReflectionMapping&&(be.copy(h.vertexNormalsModel[r]).applyMatrix3(De),k=.5*be.x+.5,F=.5*be.y+.5,be.copy(h.vertexNormalsModel[a]).applyMatrix3(De),R=.5*be.x+.5,N=.5*be.y+.5,be.copy(h.vertexNormalsModel[d]).applyMatrix3(De),H=.5*be.x+.5,B=.5*be.y+.5,u(S,O,I,A,L,T,k,F,R,N,H,B,f.envMap)):(ce.copy(f.color),f.vertexColors===n.FaceColors&&ce.multiply(h.color),f.wireframe===!0?l(ce,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):c(ce));else f.isMeshNormalMaterial?(be.copy(h.normalModel).applyMatrix3(De),ce.setRGB(be.x,be.y,be.z).multiplyScalar(.5).addScalar(.5),f.wireframe===!0?l(ce,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):c(ce)):(ce.setRGB(1,1,1),f.wireframe===!0?l(ce,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):c(ce))}function s(e,t,n,o,i,r){Q.beginPath(),Q.moveTo(e,t),Q.lineTo(n,o),Q.lineTo(i,r),Q.closePath()}function l(e,t,n,o){f(t),_(n),v(o),g(e.getStyle()),Q.stroke(),_e.expandByScalar(2*t)}function c(e){y(e.getStyle()),Q.fill()}function d(e){if(0===e.version||e instanceof n.CompressedTexture||e instanceof n.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(t.complete===!1)return{canvas:void 0,version:0};var o=e.wrapS===n.RepeatWrapping||e.wrapS===n.MirroredRepeatWrapping,i=e.wrapT===n.RepeatWrapping||e.wrapT===n.MirroredRepeatWrapping,r=e.wrapS===n.MirroredRepeatWrapping,a=e.wrapT===n.MirroredRepeatWrapping,s=document.createElement("canvas");s.width=t.width*(r?2:1),s.height=t.height*(a?2:1);var l=s.getContext("2d");l.setTransform(1,0,0,-1,0,t.height),l.drawImage(t,0,0),r===!0&&(l.setTransform(-1,0,0,-1,t.width,t.height),l.drawImage(t,-t.width,0)),a===!0&&(l.setTransform(1,0,0,1,0,0),l.drawImage(t,0,t.height)),r===!0&&a===!0&&(l.setTransform(-1,0,0,1,t.width,0),l.drawImage(t,-t.width,t.height));var c="no-repeat";o===!0&&i===!0?c="repeat":o===!0?c="repeat-x":i===!0&&(c="repeat-y");var d=Q.createPattern(s,c);return e.onUpdate&&e.onUpdate(e),{canvas:d,version:e.version}}function u(e,t,n,o,i,r,a,s,l,c,u,h,p){var m=pe[p.id];if(void 0!==m&&m.version===p.version||(m=d(p),pe[p.id]=m),void 0===m.canvas)return y("rgba( 0, 0, 0, 1)"),void Q.fill();y(m.canvas);var f,_,v,g,M,w,b,D,E=p.offset.x/p.repeat.x,x=p.offset.y/p.repeat.y,C=p.image.width*p.repeat.x,S=p.image.height*p.repeat.y;a=(a+E)*C,s=(s+x)*S,l=(l+E)*C,c=(c+x)*S,u=(u+E)*C,h=(h+x)*S,n-=e,o-=t,i-=e,r-=t,l-=a,c-=s,u-=a,h-=s,b=l*h-u*c,0!==b&&(D=1/b,f=(h*n-c*i)*D,_=(h*o-c*r)*D,v=(l*i-u*n)*D,g=(l*r-u*o)*D,M=e-f*a-v*s,w=t-_*a-g*s,Q.save(),Q.transform(f,_,v,g,M,w),Q.fill(),Q.restore())}function h(e,t,n){var o,i=t.x-e.x,r=t.y-e.y,a=i*i+r*r;0!==a&&(o=n/Math.sqrt(a),i*=o,r*=o,t.x+=i,t.y+=r,e.x-=i,e.y-=r)}function p(e){te!==e&&(Q.globalAlpha=e,te=e)}function m(e){ne!==e&&(e===n.NormalBlending?Q.globalCompositeOperation="source-over":e===n.AdditiveBlending?Q.globalCompositeOperation="lighter":e===n.SubtractiveBlending?Q.globalCompositeOperation="darker":e===n.MultiplyBlending&&(Q.globalCompositeOperation="multiply"),ne=e)}function f(e){re!==e&&(Q.lineWidth=e,re=e)}function _(e){ae!==e&&(Q.lineCap=e,ae=e)}function v(e){se!==e&&(Q.lineJoin=e,se=e)}function g(e){oe!==e&&(Q.strokeStyle=e,oe=e)}function y(e){ie!==e&&(Q.fillStyle=e,ie=e)}function M(e){le.length!==e.length&&(Q.setLineDash(e),le=e)}e=e||{};var w,b,D,E,x,C,S,O,I,A,L,T,P,k,F,R,N,H,B,j=this,z=new n.Projector,V=void 0!==e.canvas?e.canvas:document.createElement("canvas"),W=V.width,K=V.height,G=Math.floor(W/2),U=Math.floor(K/2),X=0,q=0,Y=W,Z=K,J=1,Q=V.getContext("2d",{alpha:e.alpha===!0}),$=new n.Color(0),ee=e.alpha===!0?0:1,te=1,ne=0,oe=null,ie=null,re=null,ae=null,se=null,le=[],ce=new n.Color,de=new n.Color,ue=new n.Color,he=new n.Color,pe={},me=new n.Box2,fe=new n.Box2,_e=new n.Box2,ve=new n.Color,ge=new n.Color,ye=new n.Color,Me=new n.Vector3,we=new n.Vector3,be=new n.Vector3,De=new n.Matrix3;void 0===Q.setLineDash&&(Q.setLineDash=function(){}),this.domElement=V,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return Q},this.getContextAttributes=function(){return Q.getContextAttributes()},this.getPixelRatio=function(){return J},this.setPixelRatio=function(e){void 0!==e&&(J=e)},this.setSize=function(e,t,n){W=e*J,K=t*J,V.width=W,V.height=K,G=Math.floor(W/2),U=Math.floor(K/2),n!==!1&&(V.style.width=e+"px",V.style.height=t+"px"),me.min.set(-G,-U),me.max.set(G,U),fe.min.set(-G,-U),fe.max.set(G,U),te=1,ne=0,oe=null,ie=null,re=null,ae=null,se=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,n,o){X=e*J,q=t*J,Y=n*J,Z=o*J},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){$.set(e),ee=void 0!==t?t:1,fe.min.set(-G,-U),fe.max.set(G,U)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return $},this.getClearAlpha=function(){return ee},this.getMaxAnisotropy=function(){return 0},this.clear=function(){fe.isEmpty()===!1&&(fe.intersect(me),fe.expandByScalar(2),fe.min.x=fe.min.x+G,fe.min.y=-fe.min.y+U,fe.max.x=fe.max.x+G,fe.max.y=-fe.max.y+U,ee<1&&Q.clearRect(0|fe.min.x,0|fe.max.y,fe.max.x-fe.min.x|0,fe.min.y-fe.max.y|0),ee>0&&(p(1),m(n.NormalBlending),y("rgba("+Math.floor(255*$.r)+","+Math.floor(255*$.g)+","+Math.floor(255*$.b)+","+ee+")"),Q.fillRect(0|fe.min.x,0|fe.max.y,fe.max.x-fe.min.x|0,fe.min.y-fe.max.y|0)),fe.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,o){if(void 0===o.isCamera)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");var s=e.background;s&&s.isColor?(p(1),m(n.NormalBlending),y(s.getStyle()),Q.fillRect(0,0,W,K)):this.autoClear===!0&&this.clear(),j.info.render.vertices=0,j.info.render.faces=0,Q.setTransform(Y/W,0,0,-Z/K,X,K-q),Q.translate(G,U),w=z.projectScene(e,o,this.sortObjects,this.sortElements),b=w.elements,D=w.lights,De.getNormalMatrix(o.matrixWorldInverse),t();for(var l=0,c=b.length;l<c;l++){var d=b[l],u=d.material;if(void 0!==u&&0!==u.opacity){if(_e.makeEmpty(),d instanceof n.RenderableSprite)E=d,E.x*=G,E.y*=U,i(E,d,u);else if(d instanceof n.RenderableLine)E=d.v1,x=d.v2,E.positionScreen.x*=G,E.positionScreen.y*=U,x.positionScreen.x*=G,x.positionScreen.y*=U,_e.setFromPoints([E.positionScreen,x.positionScreen]),me.intersectsBox(_e)===!0&&r(E,x,d,u);else if(d instanceof n.RenderableFace){if(E=d.v1,x=d.v2,C=d.v3,E.positionScreen.z<-1||E.positionScreen.z>1)continue;if(x.positionScreen.z<-1||x.positionScreen.z>1)continue;if(C.positionScreen.z<-1||C.positionScreen.z>1)continue;E.positionScreen.x*=G,E.positionScreen.y*=U,x.positionScreen.x*=G,x.positionScreen.y*=U,C.positionScreen.x*=G,C.positionScreen.y*=U,u.overdraw>0&&(h(E.positionScreen,x.positionScreen,u.overdraw),h(x.positionScreen,C.positionScreen,u.overdraw),h(C.positionScreen,E.positionScreen,u.overdraw)),_e.setFromPoints([E.positionScreen,x.positionScreen,C.positionScreen]),me.intersectsBox(_e)===!0&&a(E,x,C,0,1,2,d,u)}fe.union(_e)}}Q.setTransform(1,0,0,1,0,0)}};var C=function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?g[y.call(e)]||"object":typeof e},S=function(e){return"function"===C(e)},O=function(e){var t,n;return!(!e||"[object Object]"!==y.call(e))&&(!(t=v(e))||(n=M.call(t,"constructor")&&t.constructor,"function"==typeof n&&w.call(n)===b))},I=function(){var e,t,n,o,i,r,a=arguments[0]||{},s=1,l=arguments.length,c=!1;for("boolean"==typeof a&&(c=a,a=arguments[s]||{},s++),"object"==typeof a||S(a)||(a={}),s===l&&(a=this,s--);s<l;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],o=e[t],a!==o&&(c&&o&&(O(o)||(i=Array.isArray(o)))?(i?(i=!1,r=n&&Array.isArray(n)?n:[]):r=n&&O(n)?n:{},a[t]=I(c,r,o)):void 0!==o&&(a[t]=o));return a},A=function(e,t){if(!Array.isArray(e))return-1;if(Array.isArray(t)){for(var n=[],o=0,i=e.length;o<i;o++)n.push(e[o].toString());if(S(Array.prototype.indexOf))return n.indexOf(t.toString());for(var r=!1,o=0,i=n.length;o<i;o++)if(n[o]===t.toString())return r=!0,o;if(!r)return-1}else{if(S(Array.prototype.indexOf))return e.indexOf(t);for(var r=!1,o=0,i=e.length;o<i;o++)if(e[o]===t)return r=!0,o;if(!r)return-1}},L=function(e){for(var t,n=["transform","WebkitTransform","MozTransform","msTransform","OTransform"];t=n.shift();)if(e&&void 0!==e.style[t])return t;return!1},T=function(e,t){var n=L(e);return!!n&&void(0==t?e.style[n]="":e.style[n]="rotate("+t+"deg)")},P=function(){return this};P.prototype={getPoiInfo:function(){return p},setPoiInfo:function(e){var t=e||p;p=t}};var k=function(){return this.floors=[],this.building=null,this.root=null,this.is3D=!0,this.jsonData=null,this.curFloorId=null,this.curFloorCodeId=null,this};k.prototype={getBuildingId:function(){var e=this.jsonData.data.building.features[0].properties.Id||"";return e},getBuildingCodeId:function(){var e=this.jsonData.data.building.features[0].properties.CODE_ID||"";return e},getDefaultFloorId:function(){var e=this.jsonData.data.building.features[0].properties.D_Floor||"";return e},getDefaultFloorCodeId:function(){var e=this.jsonData.data.building.features[0].properties.DF_Code||"";return e},getCurFloorId:function(){return this.curFloorId},getCurFloorCodeId:function(){return this.curFloorCodeId},getFloorNum:function(){return this.jsonData.data.floors.length},getFloor:function(e){for(var t=0,n=this.floors.length;t<n;t++)if(this.floors[t].FloorId==e)return this.floors[t];return null},getFloorByName:function(e){for(var t=0,n=this.floors.length;t<n;t++)if(this.floors[t].properties.Name==e)return this.floors[t];return null},getCurFloor:function(){return this.getFloor(this.curFloorId)},getCurFloorByCodeId:function(){return this.getFloorByCodeId(this.curFloorCodeId)},getFloorJson:function(e){for(var t=this.jsonData.data.floors,n=0,o=t.length;n<o;n++)if(this.floors[n].FloorId==e)return t[n];return null},getAllFloorIDs:function(){for(var e=this.jsonData.data.floors,t=[],n=0,o=e.length;n<o;n++)t.push(e[n].properties.FloorId);return t},getAllFloorCodeIDs:function(){for(var e=this.jsonData.data.floors,t=[],n=0,o=e.length;n<o;n++)t.push(e[n].properties.CODE_ID);return t},getIDsReflection:function(){for(var e=this.jsonData.data.floors,t=[],n=0,o=e.length;n<o;n++){var i=e[n].properties.CODE_ID,r=e[n].properties.FloorId,a={};a[i]=r,t.push(a)}return t},showFloor:function(e){var t="";if(this.is3D){this.root.remove(this.building);for(var n=0,o=this.floors.length;n<o;n++)this.floors[n].FloorId==e?(this.floors[n].position.set(0,0,0),this.root.add(this.floors[n]),t=this.floors[n].CODE_ID||""):this.root.remove(this.floors[n])}this.curFloorId=e,this.curFloorCodeId=t},showAllFloors:function(){if(this.is3D){this.root.add(this.building);for(var e=4,t=0,n=this.floors.length;t<n;t++)this.floors[t].position.set(0,0,t*this.floors[t].height*e),this.root.add(this.floors[t]);return this.building.scale.set(1,1,e),this.curFloorId=F.building.getDefaultFloorId(),this.curFloorCodeId=F.building.getDefaultFloorCodeId(),this.root}}};var F,R={_animattionId:0,_boundingRect:{},_offsetLeft:0,_offsetTop:0,_sContainer:"",_sceneOrtho:null,_cameraOrtho:null,_scene:null,_renderer:null,_controls:null,_rayCaster:null,_scope:null,_params:null,_defaults:null,_list:null,_listSelected:null,_container:null,_canvasWidth:0,_canvasWidthHalf:0,_canvasHeight:0,_canvasHeightHalf:0,_canvasDiv:null,_selected:null,_showNames:!0,_showPubPoints:!0,_showLocations:!0,_locationSprites:null,_spriteMaterials:[],_pubPointSprites:null,_nameSprites:null,_selectModelListener:null,_isSelectedModelNode:!1,_kmBuilding:null,_theme:null,_json:null,_is3D:!0,_popupObj:null,_bufPos:null,_bufFlag:!1,_showPopup:!1,_showAnimation:!1,_showHistoryAnimation:!1,_cameraAnimation:!1,_moveAnimation:!1,_rotateAnimation:!1,_videoState:!1,_moveTo:[0,0],_video:null,_image:null,_imageContext:null,_imageReflection:null,_imageReflectionContext:null,_imageReflectionGradient:null,_texture:null,_textureReflection:null,_player:null,_videoIDs:[],_eventTap:e.IDM.Browser.mobile?"touchend":"click",_placeFn:null,_selectFn:null,_selectFloorFn:[],_curScale:1,_css3D:{_secne:null,_controls:null,_camera:null,_renderer:null,_wallAnimate:!1,_canvasDiv:null,_container:"",_canvasWidth:0,_canvasHeight:0,_canvasWidthHalf:0,_canvasHeightHalf:0}},N={resetGlobalVariable:function(){R&&(R={_animationId:0,_boundingRect:{},_offsetLeft:0,_offsetTop:0,_sContainer:"",_sceneOrtho:null,_cameraOrtho:null,_scene:null,_renderer:null,_controls:null,_rayCaster:null,_scope:null,_params:null,_defaults:null,_list:null,_listSelected:null,_container:null,_canvasWidth:0,_canvasWidthHalf:0,_canvasHeight:0,_canvasHeightHalf:0,_canvasDiv:null,_selected:null,_showNames:!0,_showPubPoints:!0,_showLocations:!0,_locationSprites:null,_spriteMaterials:[],_pubPointSprites:null,_nameSprites:null,_selectModelListener:null,_isSelectedModelNode:!1,_kmBuilding:null,_theme:null,_json:null,_is3D:!0,_popupObj:null,_bufPos:null,_bufFlag:!1,_showPopup:!1,_showAnimation:!1,_showHistoryAnimation:!1,_cameraAnimation:!1,_moveAnimation:!1,_rotateAnimation:!1,_videoState:!1,_moveTo:[0,0],_video:null,_image:null,_imageContext:null,_imageReflection:null,_imageReflectionContext:null,_imageReflectionGradient:null,_texture:null,_textureReflection:null,_player:null,_videoIDs:[],_eventTap:e.IDM.Browser.mobile?"touchend":"click",_placeFn:null,_selectFn:null,_selectFloorFn:[],_curScale:1,_css3D:{_secne:null,_controls:null,_camera:null,_renderer:null,_wallAnimate:!1,_canvasDiv:null,_container:"",_canvasWidth:0,_canvasHeight:0,_canvasWidthHalf:0,_canvasHeightHalf:0}}),F=null},dealloc:function(){for(var e=R._scene.children.length-1;e>=0;e--){var t=R._scene.children[e];if("KingsMapRoot"===t.type)for(var n=t.children.length-1;n>=0;n--)for(var o=t.children[n],i=o.children.length-1;i>=0;i--){var r=o.children[i];r.geometry&&r.geometry.dispose(),r.meterial&&r.meterial.dispose()}R._scene.remove(t)}for(var e=R._sceneOrtho.children.length-1;e>=0;e--){var t=R._sceneOrtho.children[e];R._sceneOrtho.remove(t)}N.cancelAnimation()},initKingsMap:function(e,t){var n,o=e,a={container:"",defaultMapType:c.MODE_3D,defaultMapScaleLevel:u.MODE_SCALE_DEFAULT,mapScaleLevelRange:u.MODE_SCALE_RANGE,modelSelectedEffect:h.MODE_MODEL_SELECTED,defaultFloorHeight:h.MODE_FLOOR_HEIGHT,defalutFloorMode:c.MODE_ALL,defaultFloorID:h.MODE_FLOOR_DEFAULT_ID,defaultShowName:h.MODE_FLOOR_NAME,defaultShowPoi:h.MODE_SHOW_POI,compass:d.MODE_COMPASS,compassOffset:d.MODE_LEFT_TOP,viewMode:d.MODE_VIEW_MODE,viewModeOffset:d.MODE_LEFT_TOP,floorsMode:d.MODE_FLOORS,floorsModeOffset:d.MODE_LEFT_TOP,zoomMode:d.MODE_ZOOM,zoomModeOffset:d.MODE_LEFT_TOP,listMode:d.MODE_LIST,listModeOffset:d.MODE_LEFT_TOP,loadingViewMode:i.MODE_VIEW_MODE,loadingViewStyle:i.MODE_LOADER_1,flashViewMode:i.MODE_FLASH_MODE};if(R._params=t,R._defaults=I(!1,a,t),""===R._defaults.container)return void alert("请先指定盛放KingsMap地图的容器");var s=document.getElementById(t.container);if(R._defaults.container=s,R._defaults.defaultMapType===c.MODE_3D)o.is3D=!0;else{if(R._defaults.defaultMapType!==c.MODE_2D)return void alert("请指定是2D或3D类型的KingsMap");o.is3D=!1}return o.is3D&&r.webgl&&(n=new j(R._defaults),R._defaults.compass&&N.setCompass(R._defaults.compassOffset,t.container),R._defaults.viewMode&&N.setViewMode(R._defaults.viewModeOffset,t.container,R._defaults.defaultMapType),R._defaults.floorsMode&&N.setFloorsMode(R._defaults.floorsModeOffset,t.container,R._defaults.defalutFloorMode),R._defaults.zoomMode&&N.setZoomMode(R._defaults.zoomModeOffset,t.container),R._defaults.loadingViewMode&&N.setLoadingView(R._defaults.loadingViewStyle),R._defaults.flashViewMode&&N.setFlashView()),n},init:function(e){F=e,R._scene=new n.Scene,F.scene=R._scene,F.camera=new n.PerspectiveCamera(20,R._canvasWidth/R._canvasHeight,.1,2e3),R._sceneOrtho=new n.Scene,R._cameraOrtho=new n.OrthographicCamera(-R._canvasWidthHalf,R._canvasWidthHalf,R._canvasHeightHalf,-R._canvasHeightHalf,1,10),R._cameraOrtho.position.z=10,R._renderer=new n.WebGLRenderer({antialias:!0}),F.renderer=R._renderer,F.renderer.autoClear=!1,F.renderer.setPixelRatio(window.devicePixelRatio),R._controls=new n.OrbitControls(F.camera,F.renderer.domElement),R._controls.addEventListener("change",N.render),R._controls.maxPolarAngle=c.MODE_MIN_ANGLE,R._controls.maxDistance=u.MODE_CAMERA_LENGTH_MAX,R._controls.minDistance=u.MODE_CAMERA_LENGTH_MIN;var t=new n.DirectionalLight(13882323);t.position.set(-500,500,-500),R._scene.add(t);var o=new n.DirectionalLight(13882323);o.position.set(500,500,500),R._scene.add(o),F.renderer.setSize(R._container.clientWidth,R._container.clientHeight),R._canvasDiv=F.renderer.domElement,R._canvasDiv.setAttribute("id","kings-map-canvas"),R._container.appendChild(R._canvasDiv),window.addEventListener("resize",N.resize,!1),R._container.style.overflow="hidden",R._canvasDiv.style.position="absolute",R._canvasDiv.style.width="100%",R._canvasDiv.style.height="100%"},initBrand:function(){var e=document.createElement("p");e.className="kings-brand",e.id="kings-brand";var t=document.createElement("span");t.innerText="Kings",e.appendChild(t);var n=document.createElement("span");n.innerText="Map",n.style.padding="0 4px",e.appendChild(n);var o=document.getElementById(R._params.container);o.appendChild(e)},hideBrand:function(){document.getElementById("kings-brand").style.display="none"},removeBrand:function(){var e=document.getElementById("kings-brand");e&&e.parentNode&&e.parentNode.removeChild(e)},hideCompass:function(){document.getElementById("compass").style.display="none"},removeCompass:function(){var e=document.getElementById("compass");e&&e.parentNode&&e.parentNode.removeChild(e)},hideViewMode:function(){document.getElementById("kings-tool-view").style.display="none"},removeViewMode:function(){var e=document.getElementById("kings-tool-view");e&&e.parentNode&&e.parentNode.removeChild(e)},hideFloorsMode:function(){document.getElementById("kings-tool-floors").style.display="none"},removeFloorsMode:function(){var e=document.getElementById("kings-tool-floors");e&&e.parentNode&&e.parentNode.removeChild(e)},hideZoomMode:function(){document.getElementById("kings-tool-zoom").style.display="none"},removeZoomMode:function(){var e=document.getElementById("kings-tool-zoom");e&&e.parentNode&&e.parentNode.removeChild(e)},hideFloorList:function(){document.getElementById("kings-floors-ul-wrap").style.display="none"},removeFloorList:function(){var e=document.getElementById("kings-floors-ul-wrap");e&&e.parentNode&&e.parentNode.removeChild(e)},removeMapCanvas:function(){var e=document.getElementById("kings-map-canvas");e&&e.parentNode&&e.parentNode.removeChild(e)},displayCompass:function(){document.getElementById("compass")?document.getElementById("compass").style.display="block":N.setCompass(R._defaults.compassOffset,R._params.container)},displayViewMode:function(){document.getElementById("kings-tool-view")?document.getElementById("kings-tool-view").style.display="block":N.setViewMode(R._defaults.viewModeOffset,R._params.container)},displayFloorsMode:function(){document.getElementById("kings-tool-floors")?document.getElementById("kings-tool-floors").style.display="block":N.setFloorsMode(R._defaults.floorsModeOffset,R._params.container,R._defaults.defalutFloorMode)},displayZoomMode:function(){document.getElementById("kings-tool-zoom")?document.getElementById("kings-tool-zoom").style.display="block":N.setZoomMode(R._defaults.zoomModeOffset,R._params.container)},displayFloorList:function(){document.getElementById("kings-floors-ul-wrap")?document.getElementById("kings-floors-ul-wrap").style.display="block":N.setFloorList(R._defaults.floorsModeOffset,R._params.container)},removeMap:function(){N.dealloc(),N.removeBrand(),N.removeCompass(),N.removeFloorList(),N.removeFloorsMode(),N.removeViewMode(),N.removeZoomMode(),N.destoryResize(),N.destoryControlsRender(),N._css3D.destoryOnWindowResize(),N._css3D.destoryControlsCSSRender(),N.removeMapCanvas(),N.resetGlobalVariable()},loadSprites:function(){if(null!=F.building&&0==R._spriteMaterials.length){var e=p;for(var t in e){var o=new n.TextureLoader,i=o.load(e[t],N.redraw),r=new n.SpriteMaterial({map:i});R._spriteMaterials[t]=r}}R._spriteMaterials.isLoaded=!0},makeTextSprite:function(e,t){void 0===t&&(t={});var o=t.hasOwnProperty("fontface")?t.fontface:"Arial",i=t.hasOwnProperty("fontsize")?t.fontsize:16,r=t.hasOwnProperty("borderThickness")?t.borderThickness:2,a=(t.hasOwnProperty("borderColor")?t.borderColor:{r:0,g:0,b:0,a:1},t.hasOwnProperty("backgroundColor")?t.backgroundColor:{r:255,g:255,b:255,a:1},t.hasOwnProperty("color")?t.color:"#000000"),s=(new n.Vector2(0,0),document.createElement("canvas")),l=s.getContext("2d");l.font="Bold "+i+"px "+o;var c=l.measureText(e),d=c.width+2*r,u=s.height;s.width=d,l.font="Bold "+i+"px "+o,l.fillStyle=a,l.fillText(e,r,i+r);var h=new n.Texture(s);h.minFilter=n.LinearFilter,h.needsUpdate=!0;var p=new n.SpriteMaterial({map:h}),m=new n.Sprite(p);return m.scale.set(d/3,u/3,1),m.width=d,m.height=u,m},drawRoundRect:function(e,t,n,o,i,r){e.beginPath(),e.moveTo(t+r,n),e.lineTo(t+o-r,n),e.quadraticCurveTo(t+o,n,t+o,n+r),e.lineTo(t+o,n+i-r),e.quadraticCurveTo(t+o,n+i,t+o-r,n+i),e.lineTo(t+r,n+i),e.quadraticCurveTo(t,n+i,t,n+i-r),e.lineTo(t,n+r),e.quadraticCurveTo(t,n,t+r,n),e.closePath(),e.fill(),e.stroke()},clearPubPointSprites:function(){null!=R._pubPointSprites&&(R._pubPointSprites.remove(R._pubPointSprites.children),R._pubPointSprites.children.length=0)},createPubPointSprites:function(e){R._spriteMaterials.isLoaded||N.loadSprites(),R._pubPointSprites?N.clearPubPointSprites():R._pubPointSprites=new n.Object3D;for(var t,o,i=F.building.getFloorJson(F.building.getCurFloorId()).poi.features,r=0,a=i.length;r<a;r++){var s=R._spriteMaterials[i[r].properties.Type];if(void 0!==s){t=20,o=20;var l=new n.Sprite(s),c=i[r].properties.Center.split(","),d=[c[0],-c[1]];l.scale.set(t,o,1),l.oriX=d[0]-R._moveTo[0],l.oriY=d[1]-R._moveTo[1],l.x=d[0],l.y=d[1],l.width=t,l.height=o,l.type="POISprite",R._pubPointSprites.add(l),R._pubPointSprites.type="KingsMapPOI"}}R._pubPointSprites.position.set(0,0,0),R._sceneOrtho.add(R._pubPointSprites)},clearNameSprites:function(){null!=R._nameSprites&&(R._nameSprites.remove(R._nameSprites.children),R._nameSprites.children.length=0)},createNameSprites:function(e){R._nameSprites?N.clearNameSprites():R._nameSprites=new n.Object3D;for(var t=F.building.getFloorJson(F.building.getCurFloorId()).features,o=0,i=t.length;o<i;o++){var r=N.makeTextSprite(t[o].properties.Name,R._theme.fontStyle),a=t[o].properties.Center.split(","),s=[a[0],-a[1]];r.oriX=s[0]-R._moveTo[0],r.oriY=s[1]-R._moveTo[1],r.x=s[0],r.y=s[1],R._nameSprites.add(r),R._nameSprites.type="KingsMapAreaName"}R._sceneOrtho.add(R._nameSprites)},updateSprites:function(e,t,o){for(var i=0,r=e.children.length;i<r;i++){var s=e.children[i],l=new n.Vector3(s.oriX*u.MODE_SCALE,0,-s.oriY*u.MODE_SCALE);l.applyMatrix4(t);var c=Math.round(l.x*R._canvasWidthHalf),d=Math.round(l.y*R._canvasHeightHalf);s.position.set(c,d,1);for(var h=o,p=5,m=0;m<i;m++){var f=s.material.map.image;if(!f){h=!1;break}var _=s.width/2,v=s.height/2,g=new a(s.position.x-_,s.position.y-v,s.position.x+v,s.position.y+v),y=e.children[m],M=y.position,w=y.width/2,b=y.height/2,D=new a(M.x-w,M.y-b,M.x+b,M.y+b);if(y.visible&&g.isCollide(D)){h=!1;break}if(g.tl[0]-=p,g.tl[1]-=p,D.tl[0]-=p,D.tl[1]-=p,0==s.visible&&g.isCollide(D)){h=!1;break}}s.visible=h}},infoWindow:function(e,t){if(!R._bufFlag)return null;var n=document.getElementById("infoWindow");n&&R._bufFlag&&n.parentNode&&n.parentNode.removeChild(n);var o=document.createElement("div");o.id="infoWindow",o.className="kings-popup";var i=document.createElement("span");i.id="kings-popup-closer",i.className="kings-popup-closer",o.appendChild(i),i.addEventListener("mousedown",function(){N.removeInfoWindow()});var r=document.createElement("div");r.id="popup-content",r.style.position="relative",r.style.overflow="hidden",t.params.popupOptions.container.length>1?r.innerHTML=t.params.popupOptions.container:r.innerHTML=t.params.popupOptions.data.name;var a=t.params.popupOptions.size[0],s=t.params.popupOptions.size[1];r.style.width=a+"px",r.style.height=s+"px",o.appendChild(r),o.style.left=e.x-a/2-20+"px",o.style.top=e.y-s-t.params.height-t.params.size+"px",document.getElementById(R._params.container).appendChild(o);var l=t.params.popupOptions.callback;l&&"function"==typeof l&&l()},worldToScreen:function(e){var t=e.point,o=new n.Vector3(t.x-R._moveTo[0],t.y-R._moveTo[1],t.z),i=R._canvasDiv.clientWidth/2,r=R._canvasDiv.clientHeight/2,a=new n.Vector3(o.x*u.MODE_SCALE,o.z*u.MODE_SCALE,-o.y*u.MODE_SCALE),s=a.project(F.camera),l={x:Math.round(s.x*i+i),y:Math.round(-s.y*r+r)};R._bufPos?R._bufPos.x!==l.x||R._bufPos.y!==l.y?(R._bufPos=l,R._bufFlag=!0):R._bufFlag=!1:(R._bufPos=l,R._bufFlag=!0),N.infoWindow(l,e)},updateLabels:function(){var e=F.building;if(null!=e&&null!=R._controls&&R._controls.viewChanged){var t=e.getCurFloor();if(null!=t){var o=null;R._showNames?void 0!=R._nameSprites&&(o=new n.Matrix4,o.multiplyMatrices(F.camera.projectionMatrix,F.camera.matrixWorldInverse),N.updateSprites(R._nameSprites,o,!0)):void 0!=R._nameSprites&&(o=new n.Matrix4,o.multiplyMatrices(F.camera.projectionMatrix,F.camera.matrixWorldInverse),N.updateSprites(R._nameSprites,o,!1)),R._showPubPoints?void 0!=R._pubPointSprites&&(o||(o=new n.Matrix4,o.multiplyMatrices(F.camera.projectionMatrix,F.camera.matrixWorldInverse)),N.updateSprites(R._pubPointSprites,o,!0)):void 0!=R._pubPointSprites&&(o||(o=new n.Matrix4,o.multiplyMatrices(F.camera.projectionMatrix,F.camera.matrixWorldInverse)),N.updateSprites(R._pubPointSprites,o,!1)),R._showLocations?void 0!=R._locationSprites&&(o||(o=new n.Matrix4,o.multiplyMatrices(F.camera.projectionMatrix,F.camera.matrixWorldInverse)),N.updateSprites(R._locationSprites,o,!0)):void 0!=R._locationSprites&&(o||(o=new n.Matrix4,o.multiplyMatrices(F.camera.projectionMatrix,F.camera.matrixWorldInverse)),N.updateSprites(R._locationSprites,o,!1)),R._controls.viewChanged=!1}}},render:function(){F.renderer.render(R._scene,F.camera)},redraw:function(){R._controls.viewChanged=!0},animate:function(){var e=new n.Vector3(-F.camera.position.x,0,-F.camera.position.z).normalize(),t=Math.atan2(-e.x,-e.z);if(T(document.getElementById("compass"),n.Math.radToDeg(t)),R._showPopup&&N.worldToScreen(R._popupObj),(R._showAnimation&&!R._showHistoryAnimation||!R._showAnimation&&R._showHistoryAnimation||R._cameraAnimation||R._moveAnimation||R._rotateAnimation)&&s.update(),R._animationId=requestAnimationFrame(N.animate),R._controls.update(),R._controls.viewChanged&&(F.renderer.clear(),F.renderer.render(R._scene,F.camera),(R._showNames||R._showPubPoints)&&N.updateLabels(),
F.renderer.clearDepth(),F.renderer.render(R._sceneOrtho,R._cameraOrtho),R._videoState)){var i;R._video.readyState===R._video.HAVE_ENOUGH_DATA?R._imageContext.drawImage(R._video,0,0,1024,512):(i=new Image,i.src=o.imgPath+"/tvbg.png",R._imageContext.drawImage(i,0,0,1024,512)),R._texture&&(R._texture.needsUpdate=!0),R._textureReflection&&(R._textureReflection.needsUpdate=!0),i?R._imageReflectionContext.drawImage(i,0,0,1024,512):R._imageReflectionContext.drawImage(R._image,0,0,1024,512),R._imageReflectionContext.fillStyle=R._imageReflectionGradient,R._imageReflectionContext.fillRect(0,0,1024,512)}R._videoState?R._controls.viewChanged=!0:R._controls.viewChanged=!1},cancelAnimation:function(){R._renderer.clear(),R._renderer.dispose(),cancelAnimationFrame(R._animationId)},resize:function(){R._canvasWidth=R._container.clientWidth,R._canvasWidthHalf=R._canvasWidth/2,R._canvasHeight=R._container.clientHeight,R._canvasHeightHalf=R._canvasHeight/2,R._offsetLeft=e.IDM.DomUtil.getElementLeft(R._container),R._offsetTop=e.IDM.DomUtil.getElementTop(R._container),R._canvasDiv.style.width="100%",R._canvasDiv.style.height="100%",R._cameraOrtho.aspect=R._canvasWidth/R._canvasHeight,R._cameraOrtho.updateProjectionMatrix(),R._renderer.setSize(R._canvasWidth,R._canvasHeight),R._controls.viewChanged=!0,N.redraw()},destoryResize:function(){window.removeEventListener("resize",N.resize,!1)},destoryControlsRender:function(){R._controls&&R._controls.removeEventListener("change",N.render)},select:function(e){e.currentHex=R._selected.material.color.getHex(),e.material.color=new n.Color(R._theme.selected),e.scale=new n.Vector3(2,2,2)},setInfoWindow:function(e){return e.params.popup?(R._showPopup=!0,void(R._popupObj=e)):null},createVideo:function(){var e=R._popupObj.params.live||!1,t=R._popupObj.params.popupOptions.data.url,n=document.createElement("video");n.id="kings-video-"+Math.floor(1e4*Math.random()),R._videoIDs=[n.id],n.setAttribute("preload","auto"),n.style.display="none";var i=document.createElement("source");e?(n.className="video-js",i.setAttribute("data-setup","{}"),i.type="application/x-mpegURL",i.src=t):(n.setAttribute("autoplay","autoplay"),n.setAttribute("loop","loop"),n.setAttribute("webkit-playsinline","true"),i.type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"',i.src=o.sourcePath+"/sharp.mp4"),n.appendChild(i);var r=document.getElementById(R._params.container);r.appendChild(n),R._player=videojs(R._videoIDs[0]),N.startVideo()},startVideo:function(){R._player&&R._player.ready(function(){var e=this;e.play()})},stopVideo:function(){R._player&&R._player.tech_.dispose()},removeVideo:function(){var e=document.getElementById(R._videoIDs[0]);e&&e.parentNode&&e.parentNode.removeChild(e)},setTVBoard:function(e){N.createVideo();var t=F.building.getCurFloor();t.visible=!1;for(var o=0,i=R._sceneOrtho.children.length;o<i;o++){var r=R._sceneOrtho.children[o];r.visible=!1}R._video=document.getElementById(R._videoIDs[0]+"_html5_api"),R._image=document.createElement("canvas"),R._image.width=1024,R._image.height=512,R._imageContext=R._image.getContext("2d"),R._imageContext.fillStyle="#000000",R._imageContext.fillRect(0,0,512,256),R._texture=new n.Texture(R._image);var a=new n.MeshBasicMaterial({map:R._texture,side:n.DoubleSide,overdraw:.5});R._imageReflection=document.createElement("canvas"),R._imageReflection.width=1024,R._imageReflection.height=512,R._imageReflectionContext=R._imageReflection.getContext("2d"),R._imageReflectionContext.fillStyle="#000000",R._imageReflectionContext.fillRect(0,0,512,256),R._imageReflectionGradient=R._imageReflectionContext.createLinearGradient(0,0,0,512),R._imageReflectionGradient.addColorStop(.2,"rgba(240, 240, 240, 1)"),R._imageReflectionGradient.addColorStop(1,"rgba(240, 240, 240, 0.5)"),R._textureReflection=new n.Texture(R._imageReflection);var s=new n.MeshBasicMaterial({map:R._textureReflection,side:n.DoubleSide,overdraw:.5}),l=new n.Object3D,c=new n.PlaneGeometry(512,256,4,4),d=new n.Mesh(c,a);l.add(d);var u=new n.Mesh(c,s);u.position.y=-128,u.position.z=128,u.rotation.x=Math.PI/2,l.add(u),l.type="KingsMapTVBoard",R._scene.add(l),R._videoState=!0},removeTVBoard:function(){for(var e=0,t=R._scene.children.length;e<t;e++){var n=R._scene.children[e];"KingsMapTVBoard"===n.type&&R._scene.remove(n)}R._videoState=!1;var o=F.building.getCurFloor();o.visible=!0;for(var e=0,t=R._sceneOrtho.children.length;e<t;e++){var i=R._sceneOrtho.children[e];i.visible=!0}N.stopVideo(),N.removeVideo()},removeInfoWindow:function(){var e=document.getElementById("infoWindow");e&&(R._showPopup=!1,R._selected=null,e.parentNode&&e.parentNode.removeChild(e))},onSelectObject:function(e){var e=window.event||e;e.preventDefault();var t=new n.Vector2;"touchstart"==e.type?(t.x=(e.touches[0].clientX-R._offsetLeft)/R._canvasDiv.clientWidth*2-1,t.y=2*-((e.touches[0].clientY-R._offsetTop)/R._canvasDiv.clientHeight)+1):(t.x=(e.clientX-R._offsetLeft)/R._canvasDiv.clientWidth*2-1,t.y=2*-((e.clientY-R._offsetTop)/R._canvasDiv.clientHeight)+1);var o=new n.Vector3(t.x,t.y,1);o.unproject(F.camera),R._rayCaster.params.Points.threshold=20,R._rayCaster.set(F.camera.position,o.sub(F.camera.position).normalize());var i=R._rayCaster.intersectObjects(F.building.root.children[0].children);if(i.length>0){if(R._selected!=i[0].object){R._selected&&"KingsMapRoom"===R._selected.type&&R._selected.material.color.setHex(R._selected.currentHex),!R._selected||"KingsMapImgCloud"!==R._selected.type&&"KingsMapCameraCloud"!==R._selected.type||N.removeInfoWindow();for(var r=0,a=i.length;r<a;r++){if(R._selected=i[r].object,R._selected.type&&"KingsMapRoom"===R._selected.type){N.select(R._selected),R._isSelectedModelNode&&R._selectModelListener(R._selected);break}if(R._selected.type&&"KingsMapImgCloud"===R._selected.type){N.setInfoWindow(R._selected);break}if(R._selected.type&&"KingsMapCameraCloud"===R._selected.type){N.setInfoWindow(R._selected);break}R._selected=null}}}else!R._selected||"KingsMapImgCloud"===R._selected.type&&"KingsMapCameraCloud"===R._selected.type||R._selected.material.color.setHex(R._selected.currentHex),R._selected=null;N.redraw()},onPlaceObject:function(e,t){var e=window.event||e;e.preventDefault();var o=new n.Vector2;"touchstart"==e.type?(o.x=(e.touches[0].clientX-R._offsetLeft)/R._canvasDiv.clientWidth*2-1,o.y=2*-((e.touches[0].clientY-R._offsetTop)/R._canvasDiv.clientHeight)+1):(o.x=(e.clientX-R._offsetLeft)/R._canvasDiv.clientWidth*2-1,o.y=2*-((e.clientY-R._offsetTop)/R._canvasDiv.clientHeight)+1);var i=new n.Vector3(o.x,o.y,1);i.unproject(F.camera),R._rayCaster.set(F.camera.position,i.sub(F.camera.position).normalize());var r=R._rayCaster.intersectObjects(F.building.root.children[0].children),a=[0,0];r.length>0&&(a[0]=r[0].uv.x,a[1]=-r[0].uv.y),"function"==typeof t&&t(a)},parsePoints:function(e){for(var t=[],o=0,i=e.length;o<i;o++){var r=new n.Vector2(parseFloat(e[o][0]),-parseFloat(e[o][1]));if(o>0){var a=t[t.length-1];r.x===a.x&&r.y===a.y||t.push(r)}else t.push(r)}return t},convertPoints:function(e){if(Array.isArray(e)&&Array.isArray(e[0]))for(var t=0,n=e.length;t<n;t++)e[t][1]=-e[t][1];else e[1]=-e[1]},initAnimate:function(e,t){var n,o,i=t.position,r={x:t.position.x,y:t.position.y,z:t.position.z},a={x:t.position.x,y:t.position.y,z:t.position.z+e.animateOptions.distance};n=new s.Tween(i).to(a,e.animateOptions.duration).delay(e.animateOptions.delay).easing(s.Easing.Linear.None).onUpdate(function(){N.redraw()}),o=new s.Tween(i).to(r,e.animateOptions.duration).easing(s.Easing.Linear.None).onUpdate(function(){N.redraw()}),n.chain(o),o.chain(n),n.start()},remove:function(e,t){for(var n,o=null,i=e.children.length-1;i>=0;i--)n=e.children[i],n&&n.type===t&&(null===o&&(o=0),o++,e.remove(n));return N.redraw(),o},calcHorizontal:function(e,t){var n=[],o=[],i=[],r=[];if(e.length<2)return e;i.push([2*e[0][0]-e[1][0],2*e[0][1]-e[1][1]]),i.push(e[0]);for(var a=1,s=e.length-1;a<s;a++){var l=Math.pow(e[a][1]-e[a-1][1],2)+Math.pow(e[a][0]-e[a-1][0],2);l>t*t&&i.push(e[a])}i.push(e[e.length-1]),i.push([2*e[e.length-1][0]-e[e.length-2][0],2*e[e.length-1][1]-e[e.length-2][1]]);for(var a=1,s=i.length-1;a<s;a++){var c=i[a-1][0],d=i[a-1][1],u=i[a][0],h=i[a][1],p=i[a+1][0],m=i[a+1][1],f=c-u,_=d-h,v=u-p,g=h-m,y=0,M=0;0===v?(y=-Math.PI/2,g<0&&(y=-y)):y=Math.atan(g/v),0===f?(M=-Math.PI/2,_<0&&(M=-M)):M=Math.atan(_/f),p<u&&(y+=Math.PI),u<c&&(M+=Math.PI);var w=(M-y-Math.PI)/2,b=y+w,D=t/Math.sin(w),E=D*Math.cos(b),x=D*Math.sin(b),C=u+E,S=h+x,O=u-E,I=h-x;n.push([C,S]),o.push([O,I])}return r=n.concat(o.reverse()),r.push(n[0]),r},setFailureInfo:function(e){setTimeout(function(){var t=document.querySelector(".KingsMap-loading");t&&(document.querySelector(".loading-info").innerText=e)},1e3)},zoomIn:function(e,t){R._controls.userZoom&&(R._controls.zoomOut(e,F.camera.position),N.redraw(),t&&"function"==typeof t&&t())},zoomOut:function(e,t){R._controls.userZoom&&(R._controls.zoomIn(e,F.camera.position),N.redraw(),t&&"function"==typeof t&&t())},updateList:function(){if(null!=R._list){var e=R._list.children;if(0!==e.length){null!=R._listSelected&&(R._listSelected.className="");var t=F.building.getCurFloorId();if("-2018"===t)R._listSelected=R._list.children[0];else for(var n=0,o=e.length;n<o;n++)e[n].getAttribute("data-value")==F.building.getCurFloorId()&&(R._listSelected=e[n]);null!=R._listSelected&&(R._listSelected.className="selected")}}},parseJSON:function(e,t,n){null==R._theme?R._theme=_.DEFAULT_3D_THEME:R._theme=n,F.building=N.parseJSONModel(e,t,R._theme),F.showFloor(F.building.getDefaultFloorId()),F.renderer.setClearColor(R._theme.background),F.building.root.type="KingsMapRoot";for(var o,i=R._scene.children.length-1;i>=0;i--)o=R._scene.children[i],o&&"KingsMapRoot"===o.type&&R._scene.remove(o);return R._scene.add(F.building.root),R._container.style.background=R._theme.background,F},parseJSONModel:function(t,o,i){var r=null;R._kmBuilding?(r=R._kmBuilding,r.floors=[]):r=new k,R._json=t,R._is3D=o,R._theme=i;var a=function(o){o.jsonData=R._json,o._is3D=R._is3D;var i,r,a=0,s=[];console.time("KingsMap Parser");for(var l=0,c=R._json.data.floors.length;l<c;l++){var d=R._json.data.floors[l];if(d.rect=e.IDM.GeomUtil.getBoundingRect(d.block.geometry.coordinates[0]),d.center=e.IDM.GeomUtil.getCenterOfBounding(d.rect),R._boundingRect=d.rect,s.push(d.center),R._is3D){var h=new n.Object3D;r=d.properties.High*m.scale*u.MODE_SCALE*10,0==r&&(r=30*u.MODE_SCALE*m.scale*10),a+=r;var p=N.parsePoints(d.block.geometry.coordinates[0]),_=new n.Shape(p);h.shape=d.rect;var v={amount:f.blockHeight,bevelEnabled:!1},g=new n.ExtrudeGeometry(_,v),y=new n.MeshLambertMaterial({color:R._theme.floor.color,opacity:R._theme.floor.opacity,transparent:R._theme.floor.transparent}),M=new n.Mesh(g,y);M.type="KingsMapBlock",M.position.set(0,0,0),h.height=r,h.add(M),h.points=[],h.FloorId=d.properties.FloorId||"",h.CODE_ID=d.properties.CODE_ID||"",h.LonLat=d.properties.LonLat||"",h.blockInfo=d,o.floors.push(h)}else d.strokeStyle=R._theme.strokeStyle.color,d.fillColor=R._theme.floor.color,o.floors.push(d);o.centers=s;for(var w=0,b=d.features.length;w<b;w++){var D=d.features[w],E="undefined"==typeof R._theme[D.properties.Type]?D.properties.Type:"default";if(R._is3D){var p=N.parsePoints(D.geometry.coordinates[0]),_=new n.Shape(p),x=D.properties.Center.split(","),C=[x[0],x[1]];h.points.push({name:D.properties.Name,type:D.properties.Type,position:new n.Vector3(C[0]*u.MODE_SCALE,r*u.MODE_SCALE,-C[1]*u.MODE_SCALE)});var v={amount:f.roomHeight,bevelEnabled:!1},S=new n.ExtrudeGeometry(_,v),O=R._theme.room[E]&&R._theme.room[E].color||"#5C4433",I=R._theme.room[E]&&R._theme.room[E].opacity||1,A=R._theme.room[E]&&R._theme.room[E].transparent||!0,y=new n.MeshLambertMaterial({color:O,opacity:I,transparent:A});y.opa=R._theme.room[E]||R._theme.room.default;var M=new n.Mesh(S,y);M.position.set(0,0,f.blockHeight),M.type="KingsMapRoom",M.roomInfo=D,M.center=C,M._Id=D.properties._Id,h.add(M);var L=(new n.Geometry).setFromPoints(p),T=new n.Line(L,new n.LineBasicMaterial(R._theme.strokeStyle));T.position.set(0,0,f.roomHeight+f.blockHeight),h.add(T)}else D.fillColor=R._theme.room[E].color,D.strokeColor=R._theme.strokeStyle.color}if(d.hasOwnProperty("wall"))for(var P=d.wall.features,k=0,H=P.length;k<H;k++){var B=P[k],j=P[k].geometry.coordinates[0];if(R._is3D){var p=N.parsePoints(j),_=new n.Shape(p),v={amount:r,bevelEnabled:!1},z=new n.ExtrudeGeometry(_,v),y=new n.MeshLambertMaterial(R._theme.wall),M=new n.Mesh(z,y);M.type="KingsMapWall",M.wallInfo=B,h.add(M);var V=(new n.Geometry).setFromPoints(p),W=new n.Line(V,new n.LineBasicMaterial(R._theme.strokeStyle));W.position.set(0,0,r),h.add(W)}}if(d.hasOwnProperty("desk"))for(var K=d.desk.features,G=0,U=K.length;G<U;G++){var X=K[G],q=K[G].geometry.coordinates[0],Y=K[G].properties.High*m.scale*u.MODE_SCALE*10;if(R._is3D){var p=N.parsePoints(q),_=new n.Shape(p),v={amount:Y,bevelEnabled:!1},Z=new n.ExtrudeGeometry(_,v),y=new n.MeshLambertMaterial(R._theme.desk),M=new n.Mesh(Z,y);M.position.set(0,0,f.blockHeight+f.roomHeight),M.type="KingsMapDesk",M.deskInfo=X,h.add(M);var J=(new n.Geometry).setFromPoints(p),Q=new n.Line(J,new n.LineBasicMaterial(R._theme.strokeStyle));Q.position.set(0,0,Y+f.blockHeight+f.roomHeight),h.add(Q)}}if(d.hasOwnProperty("chair"))for(var $=d.chair.features,ee=0,te=$.length;ee<te;ee++){var ne=$[ee],oe=$[ee].geometry.coordinates[0],ie=$[ee].properties.High*m.scale*u.MODE_SCALE*10;if(R._is3D){var p=N.parsePoints(oe),_=new n.Shape(p),v={amount:ie,bevelEnabled:!1},re=new n.ExtrudeGeometry(_,v),y=new n.MeshLambertMaterial(R._theme.chair),M=new n.Mesh(re,y);M.position.set(0,0,f.blockHeight+f.roomHeight),M.type="KingsMapChair",M.chairInfo=ne,h.add(M);var ae=(new n.Geometry).setFromPoints(p),se=new n.Line(ae,new n.LineBasicMaterial(R._theme.strokeStyle));se.position.set(0,0,ie+f.blockHeight+f.roomHeight),h.add(se)}}if(R._is3D)for(var le=0,ce=d.poi.features.length;le<ce;le++){var de=d.poi.features[le],x=de.properties.Center.split(","),ue=[[x[0],x[1]]],he=N.parsePoints(ue);h.points.push({name:de.properties.Name,type:de.properties.Type,position:new n.Vector3(he.x*u.MODE_SCALE,r*u.MODE_SCALE,-he.y*u.MODE_SCALE)})}}return console.timeEnd("KingsMap Parser"),R._is3D&&(o.root=new n.Object3D,i=t.data.building,o.root.CODE_ID=i.features[0].properties.CODE_ID||"",o.root.D_Floor=i.features[0].properties.D_Floor||"",o.root.DF_Code=i.features[0].properties.DF_Code||"",o.root.FrontAngle=i.features[0].properties.FrontAngle||"",p=N.parsePoints(i.features[0].geometry.coordinates[0]),p.length>0&&(_=new n.Shape(p),v={amount:a,bevelEnabled:!1},g=new n.ExtrudeGeometry(_,v),M=new n.Mesh(g,new n.MeshBasicMaterial(R._theme.building)),o.building=M),R._moveTo=o.centers[0],F.center=o.centers[0],o.root.position.x=-R._moveTo[0]*u.MODE_SCALE,o.root.position.z=R._moveTo[1]*u.MODE_SCALE,o.root.scale.set(u.MODE_SCALE,u.MODE_SCALE,u.MODE_SCALE),o.root.rotateOnAxis(new n.Vector3(1,0,0),-Math.PI/2)),o};return a(r)},setFloorBlock:function(t){for(var o=0,i=R._kmBuilding.jsonData.data.floors.length;o<i;o++){var r=R._kmBuilding.jsonData.data.floors[o];if(t.FloorId==r.properties.FloorId&&(r.rect=e.IDM.GeomUtil.getBoundingRect(t.blockInfo.block.geometry.coordinates[0]),R._kmBuilding.is3D)){var a=N.parsePoints(t.blockInfo.block.geometry.coordinates[0]),s=new n.Shape(a),l={amount:f.blockHeight,bevelEnabled:!1},c=new n.ExtrudeGeometry(s,l),d=new n.MeshLambertMaterial({color:R._theme.floor.color,opacity:R._theme.floor.opacity,transparent:R._theme.floor.transparent}),u=new n.Mesh(c,d);u.type="KingsMapBlock",u.position.set(0,0,0),t.add(u)}}},removeFloorBlock:function(e){return e?N.remove(e,"KingsMapBlock"):null},resetRoomHex:function(e){if(e)for(var t,n=0,o=e.children.length;n<o;n++)t=e.children[n],t&&"KingsMapRoom"===t.type&&(t.material.opacity=t.material.opa.opacity)},setCompass:function(e,t){var n=document.createElement("div");n.id="compass",e[0]<0?n.style.right=Math.abs(e[0])+"px":n.style.left=e[0]+"px",e[1]<0?n.style.bottom=Math.abs(e[1])+"px":n.style.top=e[1]+"px";var o=document.createElement("button");o.className="compass-two",n.appendChild(o);var i=document.getElementById(t);i.appendChild(n)},setViewMode:function(e,t,n){var i=document.createElement("div");i.id="kings-tool-view";var r=!1;n===c.MODE_3D?(r=!0,i.style.cssText='background : white url("'+o.imgPath+'/3D.png") no-repeat scroll 50% 50%;'):(r=!1,i.style.cssText='background : white url("'+o.imgPath+'/2D.png") no-repeat scroll 50% 50%;'),e[0]<0?i.style.right=Math.abs(e[0])+"px":i.style.left=e[0]+"px",e[1]<0?i.style.bottom=Math.abs(e[1])+"px":i.style.top=e[1]+"px";var a=document.getElementById(t);a.appendChild(i),i.addEventListener(R._eventTap,function(){r?(i.style.background='white url("'+o.imgPath+'/2D.png") no-repeat scroll 50% 50%',r=!1,F.setTopView()):(i.style.background='white url("'+o.imgPath+'/3D.png") no-repeat scroll 50% 50%',r=!0,F.setSideView())},!1)},setFloorsMode:function(e,t,n){var i=document.createElement("div");i.id="kings-tool-floors";var r=!1;n===c.MODE_ALL?(r=!0,i.style.cssText='background : white url("'+o.imgPath+'/floors.png") no-repeat scroll 50% 50%;'):n===c.MODE_ONE&&(r=!1,i.style.cssText='background : white url("'+o.imgPath+'/floor.png") no-repeat scroll 50% 50%;'),e[0]<0?i.style.right=Math.abs(e[0])+"px":i.style.left=e[0]+"px",e[1]<0?i.style.bottom=Math.abs(e[1])+"px":i.style.top=e[1]+"px";var a=document.getElementById(t);a.appendChild(i),i.addEventListener(R._eventTap,function(){if(r){i.style.background='white url("'+o.imgPath+'/floor.png") no-repeat scroll 50% 50%',r=!1;var e;e=R._defaults.defaultFloorID===h.MODE_FLOOR_DEFAULT_ID?F.building.getDefaultFloorId():R._defaults.defaultFloorID,F.showFloor(e)}else i.style.background='white url("'+o.imgPath+'/floors.png") no-repeat scroll 50% 50%',r=!0,F.showAllFloors()},!1)},setZoomMode:function(e,t){var n=document.createElement("div");n.id="kings-tool-zoom";var i=document.createElement("div");i.id="kings-tool-zoom-in";var r=document.createElement("img");r.src=o.imgPath+"/zoomin.png",r.style.width="14px",r.style.height="14px",i.appendChild(r),n.appendChild(i),i.addEventListener(R._eventTap,function(){N.zoomIn()},!1);var a=document.createElement("hr");a.id="kings-tool-zoom-mid",n.appendChild(a);var s=document.createElement("div");s.id="kings-tool-zoom-out";var l=document.createElement("img");l.src=o.imgPath+"/zoomout.png",l.style.width="14px",l.style.height="14px",s.appendChild(l),n.appendChild(s),s.addEventListener(R._eventTap,function(){N.zoomOut()},!1),e[0]<0?n.style.right=Math.abs(e[0])+"px":n.style.left=e[0]+"px",e[1]<0?n.style.bottom=Math.abs(e[1])+"px":n.style.top=e[1]+"px";var c=document.getElementById(t);c.appendChild(n)},setFlashView:function(){var e=document.querySelector(".kings-shutter");e&&e.parentNode&&e.parentNode.removeChild(e);var t=document.createElement("div");t.className="kings-shutter";var n=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div");t.appendChild(n),t.appendChild(o),t.appendChild(i);var r=document.getElementById(R._params.container);setTimeout(function(){r.appendChild(t)},10)},removeFlashView:function(){var e=document.querySelector(".kings-shutter");e&&e.parentNode&&e.parentNode.removeChild(e)},setFloorList:function(e,t){var n=document.createElement("div");n.id="kings-floors-ul-wrap",R._list=document.createElement("ul"),R._list.id="kings-floors-ul",R._selectFloorFn=[];for(var o=F.building.jsonData.data.floors,i=0,r=o.length;i<r;i++)(function(e){var t=document.createElement("li"),n=document.createTextNode(o[e].properties.Name);t.setAttribute("data-value",o[e].properties.FloorId),t.setAttribute("data-selected",!1),t.setAttribute("data-code",o[e].properties.CODE_ID),t.appendChild(n),R._selectFloorFn[e]=function(){F.showFloor(o[e].properties.FloorId);for(var t=R._list.children,n=0;n<t.length;n++)t[n].className="",t[n].setAttribute("data-selected",!1),t[n].getAttribute("data-value")===o[e].properties.FloorId.toString()&&(R._listSelected=t[n],R._listSelected.className="selected",R._listSelected.setAttribute("data-selected",!0),R._listSelected.setAttribute("data-code",o[e].properties.CODE_ID))},t.addEventListener(R._eventTap,R._selectFloorFn[e],!1),R._list.appendChild(t)})(i);n.style.position="absolute",n.appendChild(R._list),e[0]<0?n.style.right=Math.abs(e[0])+"px":n.style.left=e[0]+"px",e[1]<0?n.style.bottom=Math.abs(e[1])+"px":n.style.top=e[1]+"px";var a=document.getElementById(t);return a.appendChild(n),R._list},setLoadingView:function(e){var t=document.querySelector(".KingsMap-loading");if(t&&t.parentNode&&t.parentNode.removeChild(t),e===i.MODE_LOADER_1){var n=document.createElement("section");n.className="KingsMap-loading";var o=document.createElement("div");o.className="loader loader-1";var r=document.createElement("div");r.className="loader-outter";var a=document.createElement("div");a.className="loader-inner";var s=document.createElement("p");s.innerText="小K 正在为您努力加载中",s.className="loading-info-1 loading-info",o.appendChild(r),o.appendChild(a),n.appendChild(o),n.appendChild(s);var l=document.getElementById(R._params.container);l.appendChild(n)}else if(e===i.MODE_LOADER_2){var c=document.createElement("section");c.className="KingsMap-loading";var o=document.createElement("div");o.className="loader loader-2";var d=document.createElement("div");d.className="loader-pacman";var s=document.createElement("p");s.innerText="小K 正在为您努力加载中",s.className="loading-info-2 loading-info",o.appendChild(d),c.appendChild(o),c.appendChild(s);var l=document.getElementById(R._params.container);l.appendChild(c)}else if(e===i.MODE_LOADER_3){var u=document.createElement("section");u.className="KingsMap-loading";var o=document.createElement("div");o.className="loader loader-3";var h=document.createElement("div");h.className="css-diamond";var s=document.createElement("p");s.innerText="小K 正在为您努力加载中",s.className="loading-info-3 loading-info",o.appendChild(h),u.appendChild(o),u.appendChild(s);var l=document.getElementById(R._params.container);l.appendChild(u)}},initPoints:function(e){var t=new n.TextureLoader,o=t.load(e.image,N.redraw),i=(e.size[0],e.size[1],new n.Geometry),r=new n.PointsMaterial({map:o,transparent:!0,opacity:1,sizeAttenuation:!0,size:e.size}),a=new n.Vector3(e.point[0],e.point[1],e.height);i.vertices.push(a);var s=new n.Points(i,r);return s.type="KingsMapNaviCloud",s._Id=e._Id,s.point=new n.Vector3(e.point[0],e.point[1],e.height),s.position.z=e.height,s.params=e,s},_KingsMapHistoryMarker:function(e,t){var o=new n.TextureLoader,i=o.load(t.image,N.redraw),r=new n.SpriteMaterial({map:i}),a=t.size,s=t.size,l=new n.Sprite(r);return l.scale.set(a,s,1),l.oriX=e[0],l.oriY=e[1],l.type="KingsMapHistoryMarker",l.width=a,l.height=s,l.position.set(e[0],e[1],t.height),l},_KingsMapNaviMarker:function(e,t){var o=t.size,i=t.size,r=new n.TextureLoader,a=r.load(t.image,N.redraw),s=new n.SpriteMaterial({map:a}),l=new n.Sprite(s);return l.scale.set(o,i,1),l.oriX=e[0],l.oriY=e[1],l.x=e[0],l.y=e[1],l.width=o,l.height=i,R._locationSprites=new n.Object3D,R._locationSprites.position.set(e[0],e[1],0),R._locationSprites.add(l),R._locationSprites.type="KingsMapNaviMarker",R._locationSprites},_KingsMapLocation:function(e){var t=new n.PlaneGeometry(e.size,e.size),o=new n.TextureLoader,i=o.load(e.image,N.redraw),r=new n.MeshLambertMaterial({map:i,color:16777215,transparent:!0,opacity:1,side:n.DoubleSide}),a=new n.Mesh(t,r),s=new n.Object3D;return s.add(a),s.type="KingsMapLocation",s._Id=e._Id,s.position.set(e.point[0],e.point[1],e.height),s},_KingsMapImgCloud:function(e,t,o){var i=new n.TextureLoader,r=i.load(e.image,N.redraw),a=(e.size,e.size,new n.Geometry),s=new n.PointsMaterial({map:r,transparent:!0,opacity:1,sizeAttenuation:!0,size:e.size}),l=new n.Vector3(e.point[0],e.point[1],e.height);a.vertices.push(l);var c=new n.Points(a,s);return c.type=t,c._Id=e._Id,c.point=new n.Vector3(e.point[0],e.point[1],e.height),o?c.position.z=e.height*u.MODE_SCALE*10:c.position.z=e.height,c.params=e,c},_KingsMapTextMarker:function(e){var t=N.makeTextSprite(e.text,e.fontStyle);t.oriX=e.point[0],t.oriY=e.point[1];var o=new n.Object3D;return o._Id=e._Id,o.type="KingsMapTextMarker",o.add(t),o.position.set(e.point[0],e.point[1],e.height),o},_KingsMapThickLine:function(e,t){var o=[];o=e?N.calcHorizontal(e,t.lineType.lineWidth/2):N.calcHorizontal(t.points,t.lineType.lineWidth/2);var i=N.parsePoints(o),r=new n.Shape(i),a={amount:2,bevelEnabled:!1},s=new n.ExtrudeGeometry(r,a),l=new n.MeshLambertMaterial({color:t.lineType.lineColor,transparent:t.lineType.transparent,opacity:t.lineType.opacity}),c=new n.Mesh(s,l),d=new n.Object3D;return d.add(c),d.position.set(0,0,f.blockHeight+f.roomHeight+3),d._Id=t._Id,d.type="KingsMapLine",d.add(c),d},_KingsMapLine:function(e,t){var o=[];o=e?t.thick?N.calcHorizontal(e,t.lineType.lineWidth/2):e:t.thick?N.calcHorizontal(t.points,t.lineType.lineWidth/2):t.points;for(var i,r=N.parsePoints(o),a=[],s=0,l=r.length;s<l;s++)i=r[s],a.push(new n.Vector3(i.x,i.y,0));var c=new n.Geometry;c.vertices=a;var d=new n.MeshBasicMaterial({color:t.lineType.lineColor}),u=new n.Line(c,d),h=new n.Object3D;return h.position.set(0,0,f.blockHeight+f.roomHeight+3),h._Id=t._Id,h.type="KingsMapLine",h.add(u),h},_KingsMapSegmentThickLine:function(e,t){var o=[];o="undefined"==typeof e?t.points:e;var i=o.length,r=new n.Object3D;r.position.set(0,0,f.blockHeight+f.roomHeight+3),r._Id=t._Id,r.type="KingsMapLine";var a=function(e,o){var i=new n.Shape(e),r={amount:2,bevelEnabled:!1},a=new n.ExtrudeGeometry(i,r),s=new n.MeshLambertMaterial({color:t.lineType.lineColor,transparent:t.lineType.transparent,opacity:t.lineType.opacity}),l=new n.Mesh(a,s);o.add(l)},s=R._boundingRect.boundingBox.minX,l=-R._boundingRect.boundingBox.minY,c=R._boundingRect.boundingBox.maxX,d=-R._boundingRect.boundingBox.maxY,u=function(e){for(var t=!1,n=0,o=e.length;n<o-1;n++)if(e[n][0]>c||e[n][1]<d||e[n][0]<s||e[n][1]>l||e[n][0]==e[n+1][0]&&e[n][1]==e[n+1][1]){t=!0;break}var i=N.parsePoints(e);!t&&a(i,r)};if(i>2&&i%2===0)for(var h=0,p=i;h<p-2;h+=2){var m=[o[h],o[h+1],o[h+2]],_=N.calcHorizontal(m,t.lineType.lineWidth/2);u(_)}else if(i>2&&i%2===1)for(var h=0,p=i;h<p-2;h+=2)if(o[h+2]){var m=[o[h],o[h+1],o[h+2]],_=N.calcHorizontal(m,t.lineType.lineWidth/2);u(_)}else{var m=[o[h],o[h+1]],_=N.calcHorizontal(m,t.lineType.lineWidth/2);u(_)}else if(i>1&&i<3){var m=[o[0],o[1]],_=N.calcHorizontal(m,t.lineType.lineWidth/2);u(_)}return r},_KingsMapPolygon:function(e){var t=e.points,o=N.parsePoints(t),i=new n.Shape(o),r=new n.ShapeGeometry(i),a={color:e.color,opacity:e.opacity,transparent:e.transparent},s=new n.Mesh(r,new n.MeshBasicMaterial(a));s.position.set(0,0,e.height);var l=new n.Object3D;if(l._Id=e._Id,l.type="KingsMapPolygon",l.add(s),!e.noVertices)for(var c=0,d=o.length;c<d;c++){var u=N.createCircles(e);u.position.set(o[c].x,o[c].y,e.height),l.add(u)}if(!e.noLines){var h=N.createLines(o,e);l.add(h)}return l},createCircles:function(e){var t=5,o=32,i=new n.CircleGeometry(t,o),r=new n.MeshBasicMaterial({color:e.color}),a=new n.Mesh(i,r);return a},createLines:function(e,t){for(var o,i=[],r=0,a=e.length;r<=a;r++)o=r===a?e[0]:e[r],i.push(new n.Vector3(o.x,o.y,t.height));var s=new n.Geometry;s.vertices=i;var l=new n.MeshBasicMaterial({color:t.color}),c=new n.Line(s,l);return c},createHeatMap:function(e,t){var o=t.shape.boundingBox,i=parseFloat(o.maxX),r=parseFloat(o.maxY),a=parseFloat(o.minX),s=parseFloat(o.minY),l=Math.abs(i-a),c=Math.abs(r-s),d=document.createElement("div");d.className="heatmap",d.style.width=l+"px",d.style.height=c+"px",d.style.position="absolute",d.style.top="-99999px",d.style.left="-99999px",document.body.appendChild(d);var u=h337.create({container:document.querySelector(".heatmap")}),h={max:e.params.maxValue,data:e.params.data};u.setData(h);var p=new n.Geometry,m=new n.Vector3(a,s,0),f=new n.Vector3(i,s,0),_=new n.Vector3(i,r,0),v=new n.Vector3(a,r,0);p.vertices.push(m,f,_,v);var g=new n.Vector3(0,0,1),y=new n.Face3(0,1,2,g),M=new n.Face3(0,2,3,g);p.faces.push(y,M);var w=new n.Vector2(0,0),b=new n.Vector2(1,0),D=new n.Vector2(1,1),E=new n.Vector2(0,1),x=[w,b,D],C=[w,D,E];p.faceVertexUvs[0].push(x,C);var S=document.querySelector(".heatmap-canvas"),O=new n.Texture(S);O.minFilter=n.LinearFilter,O.needsUpdate=!0;var I=new n.MeshLambertMaterial({map:O,color:16777215,transparent:!0,opacity:1}),A=new n.Mesh(p,I);A.type="KingsHeatMap",A.position.set(0,0,0);var L=document.querySelector(".heatmap");return L&&L.parentNode&&L.parentNode.removeChild(L),this.params=null,A},_css3D:{animate:function(){R._css3D._wallAnimate&&(R._css3D._scene.rotation.y+=8e-4),requestAnimationFrame(N._css3D.animate),s.update(),R._css3D._controls.update(),N._css3D.render()},transform:function(e,t,n){s.removeAll();for(var o=0,i=t.length;o<i;o++){var r=t[o],a=e[o];new s.Tween(r.position).to({x:a.position.x,y:a.position.y,z:a.position.z},Math.random()*n+n).easing(s.Easing.Exponential.InOut).start(),new s.Tween(r.rotation).to({x:a.rotation.x,y:a.rotation.y,z:a.rotation.z},Math.random()*n+n).easing(s.Easing.Exponential.InOut).start()}new s.Tween(this).to({},2*n).onUpdate(N._css3D.render).start()},onWindowResize:function(){R._css3D._canvasDiv.style.width="100%",R._css3D._canvasDiv.style.height="100%",R._css3D._canvasWidth=R._css3D._container.clientWidth,R._css3D._canvasWidthHalf=R._css3D._canvasWidth/2,R._css3D._canvasHeight=R._css3D._container.clientHeight,R._css3D._canvasHeightHalf=R._css3D._canvasHeight/2,R._css3D._camera.aspect=R._css3D._canvasWidth/R._css3D._canvasHeight,R._css3D._camera.updateProjectionMatrix(),R._css3D._renderer.setSize(R._css3D._canvasWidth,R._css3D._canvasHeight),N._css3D.render()},destoryOnWindowResize:function(){window.removeEventListener("resize",N._css3D.onWindowResize,!1)},destoryControlsCSSRender:function(){R._css3D._controls&&R._css3D._controls.removeEventListener("change",N._css3D.render)},render:function(){R._css3D._renderer.render(R._css3D._scene,R._css3D._camera)},redraw:function(){R._css3D._controls.viewChanged=!0},createMarkerWall:function(e){for(var t=e,o=0,i=t.data.length;o<i;o++)t.table[o]=new Object,o<i&&(t.table[o]=t.data[o],t.table[o].src=t.data[o].image),t.table[o].p_x=o%20+1,t.table[o].p_y=Math.floor(o/20)+1,t.info.push(t.table[o]);for(var o=0,i=t.table.length;o<i;o++){var r=document.createElement("div");r.className="kings-element",r.style.backgroundColor="rgba(0,127,127,"+(.5*Math.random()+.25)+")";var a=document.createElement("img");a.src=t.table[o].image,r.appendChild(a),t.elements.push(r);var s=new n.CSS3DObject(r);s.position.x=4e3*Math.random()-2e3,s.position.y=4e3*Math.random()-2e3,s.position.z=4e3*Math.random()-2e3;var c=new n.Object3D;c.add(s),c.type="KingsMapMarkerWall",R._css3D._scene.add(c),t.objects.push(s);var d=new n.Object3D;d.position.x=140*t.table[o].p_x-1330,d.position.y=-(180*t.table[o].p_y)+990,t.targets.table.push(d)}for(var u=new n.Vector3,h=new n.Spherical,o=0,i=t.objects.length;o<i;o++){var p=Math.acos(-1+2*o/i),m=Math.sqrt(i*Math.PI)*p,s=new n.Object3D;h.set(800,p,m),s.position.setFromSpherical(h),u.copy(s.position).multiplyScalar(2),s.lookAt(u),t.targets.sphere.push(s)}for(var u=new n.Vector3,f=new n.Cylindrical,o=0,i=t.objects.length;o<i;o++){var m=.175*o+Math.PI,_=-(5*o)+450,s=new n.Object3D;f.set(900,m,_),s.position.setFromCylindrical(f),u.x=2*s.position.x,u.y=s.position.y,u.z=2*s.position.z,s.lookAt(u),t.targets.helix.push(s)}for(var o=0,i=t.objects.length;o<i;o++){var s=new n.Object3D;s.position.x=o%5*400-800,s.position.y=300*-(Math.floor(o/5)%5)+500,s.position.z=200*Math.floor(o/25)-800,t.targets.grid.push(s)}var v;switch(t.params.type){case l.MODE_WALL_SPHERE:v=t.targets.sphere;break;case l.MODE_WALL_HELIX:v=t.targets.helix;break;case l.MODE_WALL_GRID:v=t.targets.grid;break;default:v=t.targets.table}N._css3D.transform(v,t.objects,2e3),N._css3D.animate()}}},H=function(e){n.Loader.call(this,e),this.withCredentials=!1,this.is3D=e};H.prototype=t(Object.create(n.Loader.prototype),{load:function(e,t){this.onLoadStart(),this.loadAjaxJSON(this,e,t)},loadAjaxJSON:function(e,t,n,o){var i=new XMLHttpRequest,r=0;i.onreadystatechange=function(){if(i.readyState===i.DONE)if(200===i.status||0===i.status){
if(i.responseText){var t=JSON.parse(i.responseText);e?(R._kmBuilding=e.parse(t,R._theme),n(R._kmBuilding)):n(t)}else N.setFailureInfo("小K 很遗憾 加载失败了 请求数据为空");e&&e.onLoadComplete()}else N.setFailureInfo("小K 很遗憾 加载失败了 请检查网络");else i.readyState===i.LOADING?o&&(0===r&&(r=i.getResponseHeader("Content-Length")),o({total:r,loaded:i.responseText.length})):i.readyState===i.HEADERS_RECEIVED&&void 0!==o&&(r=i.getResponseHeader("Content-Length"))},i.open("GET",t,!0),i.withCredentials=this.withCredentials,i.send(null)},parse:function(e,t){return N.parseJSONModel(e,this.is3D,t)}});var B=function(e){var t=this,n=N.initKingsMap(t,e);return N.removeInfoWindow(),n},j=function(t){var n=this;R._container=t.container,R._offsetLeft=e.IDM.DomUtil.getElementLeft(t.container),R._offsetTop=e.IDM.DomUtil.getElementTop(t.container),R._canvasWidth=R._container.clientWidth,R._canvasWidthHalf=R._canvasWidth/2,R._canvasHeight=R._container.clientHeight,R._canvasHeightHalf=R._canvasHeight/2,this.scene=null,this.camera=null,this.renderer=null,this.building=null,this.is3D=!0,this.center=[0,0],this.mapScaleLevel=0,this.camLen=100,this.moveCopy=[],this.moveDuration=1500,this.direction="up",this.degree=0,this.rotation=0,N.init(n),N.animate()},z=(j.prototype={removeMap:function(){N.removeMap()},getSelectedModel:function(){return R._selected},getCenterOfBounding:function(){return[F.building.getCurFloor().blockInfo.center[0],-F.building.getCurFloor().blockInfo.center[1]]},setTVBoard:function(e){N.removeInfoWindow(),N.setTVBoard(e)},removeTVBoard:function(e){N.removeTVBoard(),e&&"function"==typeof e&&e()},flashView:function(){var e=document.querySelector(".kings-shutter");e&&e.classList.toggle("open")},setFlashView:function(){N.setFlashView()},removeFlashView:function(){N.removeFlashView()},setProportionMode:function(e){m.scale=e},setScaleMode:function(e){u.MODE_SCALE=e},noScrollPageById:function(e){var t=document.getElementById(e),n=t.currentStyle?t.currentStyle:document.defaultView.getComputedStyle(t,null);R._sContainer=n.overflow;var o=document.getElementById(R._params.container);o.addEventListener("mouseover",function(){t.style.overflow="hidden"},!1),o.addEventListener("mouseout",function(){t.style.overflow=R._sContainer},!1)},removeLoadingView:function(){var e=this,t=document.querySelector(".KingsMap-loading");t&&setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t),setTimeout(function(){e.flashView()},1e3)},1e3)},showLoadingView:function(e){return e!==i.MODE_LOADER_1&&e!==i.MODE_LOADER_2&&e!==i.MODE_LOADER_3?null:void N.setLoadingView(e)},getCurFloorId:function(){return F.building.getCurFloorId()},getCurFloorCodeId:function(){return F.building.getCurFloorCodeId()},getRoomInfo:function(e){return"KingsMapRoom"!==e.type?null:e.roomInfo.properties},getBlockInfo:function(e){return"KingsMapBlock"!==e.type?null:e.blockInfo},setAxes:function(e){if("undefined"!=typeof e&&"number"!=typeof e)return null;var t=e||250,o=new n.AxesHelper(t);o.type="KingsMapAxes",R._scene.add(o),N.redraw()},removeAxes:function(){return R._scene?N.remove(R._scene,"KingsMapAxes"):null},showCompass:function(e){e?N.displayCompass():N.hideCompass()},showViewMode:function(e){e?N.displayViewMode():N.hideViewMode()},showFloorsMode:function(e){e?N.displayFloorsMode():N.hideFloorsMode()},showZoomMode:function(e){e?N.displayZoomMode():N.hideZoomMode()},showFloorList:function(e){e?N.displayFloorList():N.hideFloorList()},getAllFloorIDs:function(){return R._kmBuilding.getAllFloorIDs()},getAllFloorCodeIDs:function(){return R._kmBuilding.getAllFloorCodeIDs()},getIDsReflection:function(){return R._kmBuilding.getIDsReflection()},getFloorLayer:function(e){if(this.is3D){for(var t=R._kmBuilding.floors,n=0,o=t.length;n<o;n++)if(e===t[n].FloorId){var i=t[n];return i}return null}},load:function(e,t){var n=new H(!0);return null==R._theme&&(R._theme=_.DEFAULT_3D_THEME),n.load(e,function(e){F.building=e,F.building.root.type="KingsMapRoot",R._scene.add(F.building.root),F.renderer.setClearColor(R._theme.background),R._defaults.defaultFloorID===h.MODE_FLOOR_DEFAULT_ID&&R._defaults.defalutFloorMode===c.MODE_ALL?F.showAllFloors():R._defaults.defaultFloorID!==h.MODE_FLOOR_DEFAULT_ID&&R._defaults.defalutFloorMode===c.MODE_ONE?F.showFloor(R._defaults.defaultFloorID):R._defaults.defaultFloorID===h.MODE_FLOOR_DEFAULT_ID&&R._defaults.defalutFloorMode!==c.MODE_ALL&&F.showFloor(F.building.getDefaultFloorId()),R._defaults.listMode&&(N.setFloorList(R._defaults.listModeOffset,R._params.container),N.updateList()),F.setSelectable(R._defaults.modelSelectedEffect),F.showAreaNames(R._defaults.defaultShowName),F.showPoi(R._defaults.defaultShowPoi),t&&"function"==typeof t&&t()}),F},loadTheme:function(e,t){var n=new H(!0);n.loadAjaxJSON(void 0,e,function(e){F.theme=e,R._theme=e,t&&"function"==typeof t&&t()})},setTheme:function(e){if(null==R._theme)R._theme=e,this.theme=e;else if(R._theme){R._theme=e,this.theme=e;for(var t=this.getAllFloorIDs(),n=0,o=t.length;n<o;n++)this.removeAllMarker(this.getFloorLayer(t[n]));N.parseJSON(F.building.jsonData,this.is3D,R._theme)}return F},getTheme:function(){return this.theme},setDefaultView:function(){R._controls.maxPolarAngle=c.MODE_MIN_ANGLE;var e=F.building.root.FrontAngle+Math.PI/9,t=[Math.cos(e),Math.sin(e)],n=u.MODE_CAMERA_LENGTH_MAX-R._params.defaultMapScaleLevel*u.MODE_CAMERA_SCALE_AVG;R._curScale=R._params.defaultMapScaleLevel;var o=145*Math.PI/180;return F.camLen=n,F.camera.position.set(t[1]*n,Math.sin(o)*n,t[0]*n),F.camera.lookAt(R._scene.position),R._controls.reset(),R._controls.viewChanged=!0,F.mapScaleLevel=R._params.defaultMapScaleLevel,F},setTopView:function(){return R._controls.rotateUp(R._controls.maxPolarAngle),F.camera.position.x=0,F.camera.position.y=0,R._controls.maxPolarAngle=0,F},setSideView:function(){return R._controls.maxPolarAngle=c.MODE_MIN_ANGLE,R._controls.rotateDown(R._controls.maxPolarAngle),F},rotateTo:function(e){var t=Object.getOwnPropertyNames(e).length;t<1||(1===t&&e.hasOwnProperty("up")?null!=e.up?R._controls.rotateUp(e.up):R._controls.rotateUp():1===t&&e.hasOwnProperty("down")?null!=e.down?R._controls.rotateDown(e.down):R._controls.rotateDown():1===t&&e.hasOwnProperty("left")?null!=e.left?R._controls.rotateLeft(-e.left):R._controls.rotateLeft():1===t&&e.hasOwnProperty("right")&&(null!=e.right?R._controls.rotateRight(-e.right):R._controls.rotateRight()))},rotate:function(e,t){var o=new n.Vector3(-F.camera.position.x,0,-F.camera.position.z).normalize(),i=Math.atan2(-o.x,-o.z),r=(n.Math.radToDeg(i),F.camera.position.x),a=F.camera.position.y,l=F.camera.position.z,c=e;0!==F.degree&&90!==F.degree&&F.degree!==-90&&180!==F.degree&&(c=e<0?e-F.degree:e+F.degree);var d=c*Math.PI/180,u=F.camera.position,h={x:l*Math.sin(d)+r*Math.cos(d),y:a,z:l*Math.cos(d)-r*Math.sin(d)},p=new s.Tween(u).to(h,1200).easing(s.Easing.Linear.None).onStart(function(){}).onUpdate(function(){N.redraw()}).onComplete(function(){F.degree=e,R._rotateAnimation=!1,t&&"function"==typeof t&&t()});p.start(),R._rotateAnimation=!0},getRotationForUp:function(e,t){var n=0,o=e[0],i=e[1],r=t[0],a=t[1],s=Math.abs(r-o),l=Math.abs(a-i),c=Math.sqrt(s*s+l*l),d=Math.round(Math.asin(l/c)/Math.PI*180);return a<i&&r===o?(n="left"===F.direction?-90:"right"===F.direction?90:180,F.direction="down"):a>i&&r===o?(n="up"===F.direction?0:"left"===F.direction?90:"right"===F.direction?-90:0,F.direction="up"):a===i&&r<o?(n="up"!==F.direction?-90:90,F.direction="right"):a===i&&r>o?(n="down"===F.direction?90:("up"===F.direction,-90),F.direction="left"):a>i&&r>o?(n=90-d,"up"===F.direction&&(n=d-90),F.direction="up"):a>i&&r<o?(n=90-d,"right"!==F.direction&&(n=90+d),F.direction="down"):a<i&&r<o?(n="up"===F.direction?90+d:"up"!==F.direction?d-90:90+d,F.direction="right"):a<i&&r>o&&(n=270-d,"right"!==F.direction&&(n=-d),F.direction="down"),n},setMoveDuration:function(e){var t=e||1500;return this.moveDuration=t,this.moveDuration},moveTo:function(e,t,n){var o=t.concat();N.convertPoints(o);var i=this,r=o[0],a=o[1],l=F.building.centers[0][0],c=F.building.centers[0][1];F.moveCopy.length>0&&(l=F.moveCopy[0],c=F.moveCopy[1],R._moveTo=[l,c]);var d={x:l,y:c},h={x:r,y:a},p=Math.abs(l-r),m=Math.abs(c-a),f=Math.round(Math.sqrt(p*p+m*m));f/150*1e3>=1500?i.setMoveDuration(f/150*1e3):i.setMoveDuration(),R._moveTo=[r,a];var _=function(){for(var e=0,t=R._nameSprites.children.length;e<t;e++){var n=R._nameSprites.children[e];n.oriX=n.x-d.x,n.oriY=n.y-d.y}},v=function(){for(var e=0,t=R._pubPointSprites.children.length;e<t;e++){var n=R._pubPointSprites.children[e];n.oriX=n.x-d.x,n.oriY=n.y-d.y}},g=new s.Tween(d).to(h,F.moveDuration).easing(s.Easing.Linear.None).onStart(function(){}).onUpdate(function(){F.building.root.position.x=-d.x*u.MODE_SCALE,F.building.root.position.z=d.y*u.MODE_SCALE,_(),v(),N.redraw()}).onComplete(function(){R._moveAnimation=!1,e&&(F.moveCopy=[d.x,d.y],i.setMoveDuration()),n&&"function"==typeof n&&n()});g.start(),R._moveAnimation=!0},adjustCamera:function(){F.setDefaultView()},setZoomTo:function(e,t){if(e<1||e>16)return null;var o=F.camera.position,i=o.x/F.camLen,r=o.y/F.camLen,a=o.z/F.camLen,l=u.MODE_CAMERA_LENGTH_MAX-e*u.MODE_CAMERA_SCALE_AVG;F.camLen=l,F.mapScaleLevel=e;var c=new n.Vector3(i*l,r*l,a*l),d=new s.Tween(o).to(c,F.moveDuration).easing(s.Easing.Linear.None).onStart(function(){}).onUpdate(function(){N.redraw()}).onComplete(function(){R._cameraAnimation=!1,t&&"function"==typeof t&&t()});d.start(),R._cameraAnimation=!0},showFloor:function(e){if(null!=R._kmBuilding.showFloor)return R._kmBuilding.showFloor(e),F.adjustCamera(),R._showPubPoints&&N.createPubPointSprites(e,!1),R._showNames&&N.createNameSprites(e,!1),N.redraw(),F},showAllFloors:function(){if(null!==F.building&&void 0!==F.building)return F.building.showAllFloors(),F.adjustCamera(),N.clearPubPointSprites(),N.clearNameSprites(),N.redraw(),F},setSelectable:function(e){return e?(R._rayCaster=new n.Raycaster,R._selectFn=function(e){N.onSelectObject(e)},R._container.addEventListener(R._eventTap,R._selectFn,!1)):F.destorySelectable(),F},destorySelectable:function(){"function"==typeof R._selectFn&&R._container.removeEventListener(R._eventTap,R._selectFn,!1)},setPlaceObject:function(e,t){return R._placeFn=function(e){N.onPlaceObject(e,t)},e&&"function"==typeof t?(F.setSelectable(!1),R._rayCaster=new n.Raycaster,R._container.addEventListener(R._eventTap,R._placeFn,!1)):(F.setSelectable(!0),F.destoryPlaceObject()),F},destoryPlaceObject:function(){"function"==typeof R._placeFn&&R._container.removeEventListener(R._eventTap,R._placeFn,!1)},setMovable:function(e){return R._controls.enable=e,F},showAreaNames:function(e){return R._showNames=void 0===e||e,N.redraw(),F},showPoi:function(e){return R._showPubPoints=void 0===e||e,N.redraw(),F},getSelectedId:function(){return R._selected._Id},setSelectModelListener:function(e){return R._selectModelListener=e,F},selectById:function(e){for(var t=F.building.getCurFloor(),n=0,o=t.children.length;n<o;n++)t.children[n]._Id&&t.children[n]._Id==e&&(R._selected&&R._selected.material.color.setHex(R._selected.currentHex),N.select(t.children[n]))},gestureEnable:function(e){O(e)&&e.hasOwnProperty("enableMapPan")&&(e.enableMapPan?(R._controls.userPan=e.enableMapPan,R._controls.userPanSpeed=1.5):(R._controls.userPan=e.enableMapPan,R._controls.userPanSpeed=0)),O(e)&&e.hasOwnProperty("enableMapZoom")&&(R._controls.userZoom=e.enableMapZoom),O(e)&&e.hasOwnProperty("enableMapRotate")&&(R._controls.userRotate=e.enableMapRotate),O(e)&&e.hasOwnProperty("enableMapIncline")&&(e.enableMapIncline?(R._controls.minPolarAngle=0,R._controls.maxPolarAngle=c.MODE_MIN_ANGLE):(R._controls.minPolarAngle=c.MODE_MIN_ANGLE,R._controls.maxPolarAngle=c.MODE_MIN_ANGLE)),R._controls.update()},removeAllLineMarker:function(e){if(e)return N.remove(e,"KingsMapLine")},removeAllImgMarker:function(e){if(e)return N.remove(e,"KingsMapImgCloud")},removeAllTextMarker:function(e){if(e)return N.remove(e,"KingsMapTextMarker")},removeAllPolygonLayer:function(e){if(e)return N.remove(e,"KingsMapPolygon")},removeAllLocationMarker:function(e){if(e)return N.remove(e,"KingsMapLocation")},removeAllCameraMarker:function(e){if(e)return N.remove(e,"KingsMapCameraCloud")},removeAllHistoryMarker:function(e){if(e)return N.remove(e,"KingsMapHistoryMarker")},removeAllSearchNode:function(e){if(e)return N.remove(this.base,"KingsMapSearchNode")},removeAllNaviMarker:function(){for(var e=0,t=R._scene.children.length-1;t>=0;t--){var n=R._scene.children[t];"KingsMapNaviMarker"===n.type&&(e++,R._scene.remove(n))}return e},removeHeatMap:function(e){for(var t,n=null,o=e.children.length-1;o>=0;o--)t=e.children[o],"KingsHeatMap"===t.type&&(null===n&&(n=0),n++,e.remove(t));return N.resetRoomHex(e),N.setFloorBlock(e),N.redraw(),n},removeAllMarker:function(e){this.removeAllLineMarker(e),this.removeAllPolygonLayer(e),this.removeAllTextMarker(e),this.removeAllImgMarker(e),this.removeAllLocationMarker(e),this.removeAllHistoryMarker(e),this.removeAllCameraMarker(e),this.removeAllNaviMarker();for(var t=0,n=!1,o=e.children.length;t<o;t++)"KingsHeatMap"===e.children[t].type&&(n=!0);n&&(n=!1,this.removeHeatMap(e))},setSelectModelNode:function(e){R._selected=null,R._isSelectedModelNode=e},addLayerMarker:function(e,t){return null===t?null:(e.add(t),void N.redraw())},removeLayerMarker:function(e,t){return null===t?null:(e.remove(t),void N.redraw())},addLineMarker:function(e,t){return null===t?null:(e.add(t),void N.redraw())},removeLineMarker:function(e,t){return null===t?null:(e.remove(t),void N.redraw())},addTextMarker:function(e,t){return null===t?null:(e.add(t),void N.redraw())},removeTextMarker:function(e,t){return null===t?null:(e.remove(t),void N.redraw())},addImgMarker:function(e,t){return null===t?null:(e.add(t),void N.redraw())},removeImgMarker:function(e,t){return null===t?null:(e.remove(t),void N.redraw())},addLocationMarker:function(e,t){return null===t?null:(e.add(t),void N.redraw())},removeLocationMarker:function(e,t){return null===t?null:(e.remove(t),void N.redraw())},addCameraMarker:function(e,t){return null===t?null:(e.add(t),void N.redraw())},removeCameraMarker:function(e,t){return null===t?null:(e.remove(t),void N.redraw())},addNaviMarker:function(e){return null===e?null:(R._sceneOrtho.add(e),void N.redraw())},removeNaviMarker:function(e){return null===e?null:(R._sceneOrtho.remove(e),void N.redraw())},changeRoomHex:function(e){if(e)for(var t,n=0,o=e.children.length;n<o;n++)t=e.children[n],t&&"KingsMapRoom"===t.type&&(t.material.opacity=.4)},applyHeatMap:function(e,t){if(null==t)return null;this.changeRoomHex(e);this.removeAllMarker(e),N.removeFloorBlock(e);e.add(t),N.redraw()}},function(e){this.layer=null;var t={_Id:"",color:"#4169E1",opacity:.5,transparent:!0,height:f.blockHeight+f.roomHeight+8,noVertices:!1,noLines:!1,points:[]},n=I(!1,t,e);return this.layer=N._KingsMapPolygon(n),this.layer}),V=function(e){this.layer=null;var t={thick:!0,segments:!1,_Id:"",lineType:{lineWidth:2,lineColor:"#40B24A",transparent:!0,opacity:1},points:[]},n=I(!1,t,e);return n.segments?this.layer=N._KingsMapSegmentThickLine(void 0,n):n.thick?this.layer=N._KingsMapThickLine(void 0,n):this.layer=N._KingsMapLine(void 0,n),this.layer},W=function(e){this.layer=null;var t={_Id:"",text:"Hello Kingsley",height:f.blockHeight+3,point:[],fontStyle:{color:"#BC2121",fontsize:40,fontface:"Helvetica, MicrosoftYaHei "}},n=I(!1,t,e);return N.convertPoints(n.point),"string"==typeof n.text&&Array.isArray(n.point)?(this.layer=N._KingsMapTextMarker(n),this.layer):null};W.prototype.setPosition=function(e){"undefined"!=typeof e&&this.layer.position.set(e.point[0],e.point[1],e.height)};var K=function(e){this.layer=null,this.animate=null,this.params=null;var t={_Id:"",image:o.imgPath+"/peopleMarker.png",animate:!1,animateOptions:{duration:500,delay:10,distance:30},popup:!0,popupOptions:{size:[80,30],data:{name:"Kingsley"},container:""},size:16,height:f.blockHeight+3,point:[]},n=I(!1,t,e);return n.point=n.point.concat(),N.convertPoints(n.point),this.params=n,this.layer=N._KingsMapImgCloud(n,"KingsMapImgCloud",!1),n.animate?(this.setAnimation(t,this.layer),R._showAnimation=!0,R._showHistoryAnimation=!1):R._showAnimation=!1,this.layer};K.prototype={setAnimation:function(e,t){return this.animate?this.animate:(N.initAnimate(e,t),this.animate=!0,this.animate)},removeAnimation:function(){return this.animate=R._showAnimation=!1,this.animate}};var G=function(e){this.layer=null;var t={_Id:"",image:o.imgPath+"/pointer.png",size:16,height:f.blockHeight+f.roomHeight+8,point:[]},n=I(!1,t,e);return n.point=n.point.concat(),N.convertPoints(n.point),this.layer=N._KingsMapLocation(n),this.layer};G.prototype.setPosition=function(e){"undefined"!=typeof e&&this.layer.position.set(e.point[0],-e.point[1],e.height)};var U=function(e){this.layer=null,this.params=null;var t={_Id:"",image:o.imgPath+"/camera.png",size:16,live:!1,popup:!0,popupOptions:{size:[80,30],data:{name:"Kingsley",url:""},container:"",callback:function(){}},height:f.blockHeight+3,point:[]},n=I(!1,t,e);return n.point=n.point.concat(),N.convertPoints(n.point),this.params=n,this.layer=N._KingsMapImgCloud(n,"KingsMapCameraCloud",!1),this.layer};U.prototype={setPosition:function(e){"undefined"!=typeof e&&this.layer.position.set(e.point[0],-e.point[1],e.height)}};var X=function(e){this.layer=null;var t={_Id:"",image:o.imgPath+"/pointer.png",size:16},n=I(!1,t,e);return n.point=n.point.concat(),N.convertPoints(n.point),this.layer=N._KingsMapNaviMarker([0,0],n),this.layer},q=function(e,t){this.layer=null,this.params=null;var n=this,o={_Id:"",maxValue:0,data:[]};return this.params=I(!1,o,e),this.layer=N.createHeatMap(n,t),this.layer},Y=function(e){this.map=null,this.base=null,this.line=null,this.start=null,this.end=null,this.params=null,this.scale=1,this.current=null,this.target=null,this._Id="0",this.speech=null,this.isCb=!1,this.isRotateCb=!1,this.rotateCallback=null,this.durationCallback=null,this.direction="",this.remove=!1,this.marker=null;var t=this,n={_Id:"",base:void 0,scale:1,thick:!1,lineType:{lineWidth:2,lineColor:"#63498B",transparent:!0,opacity:1}};if(!e.hasOwnProperty("base"))return null;var o=I(!1,n,e);this.params=o,this.base=o.base,this.scale=o.scale,this._Id=o._Id;var i=document.createElement("button");i.id="KingsMapRotationBuf_"+this._Id,i.setAttribute("data-click","false"),i.text="",i.style.display="none";var r=document.getElementById(R._params.container);r.appendChild(i);var a=document.getElementById("KingsMapRotationBuf_"+this._Id);return a.setAttribute("data-click","true"),a.addEventListener("click",function(){var e=a.text;e===-90?t.direction="右转":90===e?t.direction="左转":180===e||0===e?t.direction="直行":e>-90&&e<0?t.direction="向左前方":e>0&&e<90&&(t.direction="向右前方")},!1),this};Y.prototype={setStartPoint:function(e){var t={point:[0,0],image:o.imgPath+"/start.png",size:32,height:f.blockHeight+3},n=I(!1,t,e);n.point=n.point.concat(),N.convertPoints(n.point),this.start=N.initPoints(n),this.start.point=n.point,this.base.add(this.start),N.redraw()},setEndPoint:function(e){var t={point:[0,0],image:o.imgPath+"/end.png",size:32,height:f.blockHeight+3},n=I(!1,t,e);n.point=n.point.concat(),N.convertPoints(n.point),this.end=N.initPoints(n),this.end.point=n.point,this.base.add(this.end),N.redraw()},drawNaviLine:function(e){var t=e.concat();N.convertPoints(t),this.params.thick?this.line=N._KingsMapThickLine(t,this.params):this.line=N._KingsMapLine(t,this.params),this.base.add(this.line),N.redraw()},removeStartPoint:function(){return null===this.start||null===this.base?null:(this.base.remove(this.start),void N.redraw())},removeEndPoint:function(){return null===this.end||null===this.base?null:(this.base.remove(this.end),void N.redraw())},removeNaviLine:function(){return null===this.line||null===this.base?null:(this.base.remove(this.line),void N.redraw())},removeNavigation:function(){return null===this.base?null:(this.start&&this.removeStartPoint(),this.end&&this.removeEndPoint(),this.line&&this.removeNaviLine(),this.marker&&this.map.removeNaviMarker(this.marker),this.remove=!0,R._moveAnimation=!1,R._rotateAnimation=!1,void N.redraw())},measureDistance:function(e,t,n,o){var i=0,r=t||this.scale;if(!Array.isArray(e))return i*r;if(e.length<2)return i*r;var a=e.concat();N.convertPoints(a);for(var s=n||1,l=o||a.length,c=s,d=l;c<d;c++){var u=a[c-1][0],h=a[c-1][1],p=a[c][0],m=a[c][1],f=Math.abs(p-u),_=Math.abs(m-h);i+=Math.sqrt(f*f+_*_)}return Math.round(i*r)},measureStraightDistance:function(e,t,n){var o=0,i=n||this.scale;if(!Array.isArray(e)||!Array.isArray(t))return o*i;var r=e.concat(),a=t.concat();N.convertPoints(r),N.convertPoints(a);var s=r[0],l=r[1],c=a[0],d=a[1],u=Math.abs(c-s),h=Math.abs(d-l);return o=Math.sqrt(u*u+h*h),Math.round(o*i)},measurePointsDistance:function(e,t,n,o){var i=0,r=o||this.scale;if(!Array.isArray(e))return i*r;if(e.length<2)return i*r;if(!Array.isArray(t)||!Array.isArray(n))return i*r;var a=t.concat(),s=n.concat(),l=e.concat();N.convertPoints(a),N.convertPoints(s),N.convertPoints(l);for(var c=[],d=0,u=l.length;d<u;d++)c.push(l[d].toString());var h=A(c,a)===-1?0:A(c,a),p=A(c,s)===-1?0:A(c,s);return h>p&&(p=c.length-1-h,h=c.length-1-p),h+=1,p+=1,i=this.measureDistance(e,r,h,p)},getDirectionTurns:function(){var e=this;return e.direction},voiceText:function(e){if("string"!=typeof e)return null;var t=new window.SpeechSynthesisUtterance,n=window.speechSynthesis,o=n.getVoices();for(E=0,len=o.length;E<len;E++)if("zh-CN"===o[E].lang){t.voice=o[E],t.lang="zh-CN";break}return this.speech=t,this.speech.text=e,window.speechSynthesis.speak(this.speech),this.speech},setDurationCallback:function(e,t){return e&&"function"==typeof t?(this.isCb=e,void(this.durationCallback=t)):null},setRotateCallback:function(e,t){return e&&"function"==typeof t?(this.isRotateCb=e,void(this.rotateCallback=t)):null},getCurrent:function(){return this.current},getTarget:function(){return this.target},startNavigation:function(e,t,n){var o=this;o.map=e;var i=document.getElementById("KingsMapRotationBuf_"+this._Id);e.moveTo(!0,t[0],function(){e.setTopView(),e.setZoomTo(15,function(){var r=new X({size:32,point:t[0]});e.addNaviMarker(r),o.marker=r;var a=0,s=function(){var r=e.getRotationForUp(t[a],t[a+1]);if(F.rotation=r,o.current=t[a],o.target=t[a+1],i.text=F.rotation,"true"===i.getAttribute("data-click")){var l=document.createEvent("HTMLEvents");l.initEvent("click",!1,!0),i.dispatchEvent(l)}o.isCb&&o.durationCallback(),e.rotate(r,function(){o.isRotateCb&&o.rotateCallback(),e.moveTo(!0,t[a+1],function(){a++,a!==t.length-1?o.remove||s(a):n&&"function"==typeof n&&n()})})};s(a)})})}};var Z=function(e){return e?(this.base=e,this):null};Z.prototype={getRoomSearch:function(e){var t={_Id:"",name:"",dim:!1},n=I(!1,t,e);if(!this.base)return null;if(""!==n.name&&""===n._Id){var o=n.name,i=n.dim,r=this.base.blockInfo.features||[],a=[],s="";if(i){for(var l=o.split(""),c=0,a=[],d=r.length;c<d;c++){s=r[c].properties.Name;for(var u=0,h="",p=l.length;u<p;u++)if(h=l[u],s.indexOf(h)!==-1)if(0===a.length)a.push(r[c]);else{for(var m=0,f=!1,_=a.length;m<_;m++)r[c].properties._Id===a[m].properties._Id&&(f=!0);f||a.push(r[c])}}return a}for(var c=0,a=[],v=r.length;c<v;c++)s=r[c].properties.Name,s.indexOf(o)!==-1&&a.push(r[c]);return a}if(""===n.name&&""!==n._Id){for(var o=n._Id,r=this.base.blockInfo.features||[],a=[],g="",c=0,v=r.length;c<v;c++)g=r[c].properties._Id,g==o&&a.push(r[c]);return a}},getPoiSearch:function(e){if(!e)return null;var t=[];if(e.hasOwnProperty("type")&&!e.hasOwnProperty("name")){var n=this.base.blockInfo.poi||[];if(""===e.type)return t;for(var o=0,i=n.features.length;o<i;o++)n.features[o].properties.Type==e.type&&t.push(n.features[o])}if(e.hasOwnProperty("name")&&!e.hasOwnProperty("type")){if(""===e.name)return t;for(var o=0,i=n.length;o<i;o++)n.features[o].properties.Name.indexOf(e.name)!==-1&&t.push(n.features[o])}return t},addSearchNode:function(e){var t={image:o.imgPath+"/loc.png",height:f.blockHeight+f.roomHeight+3,size:16,dataList:[]},i=I(!1,t,e),r=function(e,t){var o=new n.TextureLoader,i=o.load(t.image,N.redraw),r=new n.SpriteMaterial({map:i}),a=t.size,s=t.size,l=new n.Sprite(r);return l.scale.set(a,s,1),l.oriX=parseFloat(e[0]),l.oriY=parseFloat(e[1]),l.width=a,l.height=s,l.position.set(e[0],e[1],t.height),l},a=null,s=new n.Object3D;s.type="KingsMapSearchNode";for(var l=0,c=i.dataList.length;l<c;l++)i.dataList[l].properties.hasOwnProperty("Center")?point=i.dataList[l].properties.Center.split(","):point=[-99999,-99999],a=r(point,i),s.add(a);this.base.add(s),N.redraw()},removeSearchNode:function(){if(this.base)return N.remove(this.base,"KingsMapSearchNode")}};var J=function(e){return this.params=null,this.layer=null,this.base=null,this.animate=!1,this.start=[],Array.isArray(e)?this.coordinates=e:this.coordinates=[],this};J.prototype={setHistoryMarker:function(e){var t={x:0,y:0},n=this.coordinates[0],i=n.concat();N.convertPoints(i),this.coordinates.length>0&&(t={x:i[0],y:i[1]}),this.start=[t.x,t.y];var r={_Id:"",image:o.imgPath+"/peopleMarker.png",size:16,height:f.blockHeight+3,base:null},a=I(!1,r,e);return a.base?(this.params=a,this.base=a.base,this.layer=N._KingsMapHistoryMarker(this.start,a),a.base.add(this.layer),this.layer):null},enableHistoryAnimation:function(e){return R._showHistoryAnimation=void 0!==e&&e,R._showAnimation=!1,R._showHistoryAnimation},startReView:function(e,t){var n=e.concat();N.convertPoints(n);var o=this.layer.position,i={x:n[0],y:n[1],z:this.layer.position.z},r=new s.Tween(o).to(i,t).easing(s.Easing.Linear.None).onStart(function(){}).onUpdate(function(){N.redraw()}).onComplete(function(){});r.start()},removeHistoryMarker:function(){if(this.base)return N.remove(this.base,"KingsMapHistoryMarker")},remove:function(){if(this.base){var e=N.remove(this.base,"KingsMapHistoryMarker")||0,t=N.remove(this.base,"KingsMapLine")||0;return e+t}}};var Q=function(){return this};Q.prototype={enablePlaceObject:function(e,t){e?F.setPlaceObject(!0,t):F.setPlaceObject(!1,t)}};var $=function(){return this};$.prototype={onFloorChange:function(e){for(var t=document.getElementById("kings-floors-ul"),n=t.childNodes,o=0;o<n.length;o++){var i=n[o];i.addEventListener(R._eventTap,function(){var t=i.getAttribute("data-value"),n=i.getAttribute("data-code");e(t,n)},!1)}}};var ee=function(e){var t=document.getElementById(e.container);R._css3D._container=t,R._css3D._canvasWidth=R._css3D._container.clientWidth,R._css3D._canvasWidthHalf=R._css3D._canvasWidth/2,R._css3D._canvasHeight=R._css3D._container.clientHeight,R._css3D._canvasHeightHalf=R._css3D._canvasHeight/2,R._css3D._camera=new n.PerspectiveCamera(40,R._css3D._canvasWidth/R._css3D._canvasHeight,1,1e4),R._css3D._camera.position.z=3e3,R._css3D._scene=new n.Scene,R._css3D._renderer=new n.CSS3DRenderer,R._css3D._canvasDiv=R._css3D._renderer.domElement,R._css3D._canvasDiv.style.position="absolute",R._css3D._canvasDiv.style.overflow="hidden",R._css3D._canvasDiv.style.width="100%",R._css3D._canvasDiv.style.height="100%",R._css3D._container.appendChild(R._css3D._canvasDiv),R._css3D._renderer.setSize(R._css3D._canvasWidth,R._css3D._canvasHeight),window.addEventListener("resize",N._css3D.onWindowResize,!1),R._css3D._controls=new n.OrbitControls(R._css3D._camera,R._css3D._renderer.domElement),R._css3D._controls.addEventListener("change",N._css3D.render)},te=function(e){this.data=null,this.params=null,this.info=[],this.elements=[],this.table=[],this.sphere=[],this.helix=[],this.grid=[],this.objects=[],this.targets={table:[],sphere:[],helix:[],grid:[]};var t={data:[],type:"helix",animate:!0},n=I(!1,t,e);return this.params=n,Array.isArray(n.data)?this.data=n.data:this.data=[],R._css3D._wallAnimate=n.animate,R._css3D._scene.rotation.x=0,R._css3D._scene.rotation.y=0,R._css3D._scene.rotation.z=0,N._css3D.createMarkerWall(this),N._css3D.onWindowResize(),this};te.prototype={remove:function(){for(var e=document.querySelectorAll(".kings-element"),t=R._css3D._scene.children.length-1;t>=0;t--){var n=R._css3D._scene.children[t];"KingsMapMarkerWall"===n.type&&R._css3D._scene.remove(n)}for(var t=0;t<e.length;t++)e[t].parentNode.removeChild(e[t])}},e.KMCSS3D=ee,e.KMLoadingView=i,e.KMWallType=l,e.KMView=c,e.KMControl=d,e.KMScale=u,e.KMFloor=h,e.KMPoi=p,e.KMDefault=f,e.KMTheme=_,e.KMInit=B,e.KMap3D=j,e.KMImgController=P,e.KMPolygonLayer=z,e.KMLineMarker=V,e.KMTextMarker=W,e.KMImgMarker=K,e.KMLocationMarker=G,e.KMCameraMarker=U,e.KMNaviMarker=X,e.KMHistory=J,e.KMSearchAnalyser=Z,e.KMHeatMap=q,e.KMNavigation=Y,e.KMMarkerWall=te,e.KMObjectController=Q,e.KMFloorController=$}(),console.log(["                   _ooOoo_","                  o8888888o",'                  88" . "88',"                  (| -_- |)","                  O\\  =  /O","               ____/`---'\\____","             .'  \\\\|     |//  `.","            /  \\\\|||  :  |||//  \\","           /  _||||| -:- |||||-  \\","           |   | \\\\\\  -  /// |   |","           | \\_|  ''\\---/''  |   |","           \\  .-\\__  `-`  ___/-. /","         ___`. .'  /--.--\\  `. . __",'      ."" \'<  `.___\\_<|>_/___.\'  >\'"".',"     | | :  `- \\`.;`\\ _ /`;.`/ - ` : | |","     \\  \\ `-.   \\_ __\\ /__ _/   .-` /  /","======`-.____`-.___\\_____/___.-`____.-'======","                   `=---='","^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^","    JSLib   : "+e.NAME,"    Version : "+e.VERSION,"    Date    : "+e.VERSION_DATE,"    Author  : "+e.AUTHOR,"    Email   : "+e.EMAIL,"^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"].join("\n")),Object.defineProperty(e,"__esModule",{value:!0})});